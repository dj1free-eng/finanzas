<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Econom√≠a Familiar ¬∑ v5d</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <style>
    :root {
      --bg: #e0f7fa;
      --card-bg: #ffffff;
      --primary: #2563eb;
      --danger: #dc2626;
      --success: #16a34a;
      --text: #111827;
      --muted: #4b5563;
      --border: #d1d5db;
      --radius: 14px;
      --shadow: 0 8px 20px rgba(15, 23, 42, 0.12);
    }
    * { box-sizing: border-box; font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; }
    html, body {
      margin: 0;
      padding: 0;
      max-width: 100vw;
      overflow-x: hidden;
    }
    body { background: var(--bg); color: var(--text); }
    .app { max-width: 900px; margin: 0 auto; padding: 0 1rem 4.5rem; }
    header {
      position: sticky; top: 0; z-index: 20;
      background: rgba(224, 247, 250, 0.96);
      backdrop-filter: blur(10px);
      padding: 0.75rem 0 0.6rem;
      margin: 0 -1rem 0.4rem;
      border-bottom: 1px solid rgba(148,163,184,0.4);
    }
    .header-inner {
      max-width: 900px;
      margin: 0 auto;
      padding: 0 1rem;
      display: flex;
      flex-direction: column;
      gap: 0.4rem;
    }
    .title-row { display: flex; align-items: center; justify-content: space-between; gap: 0.6rem; }
    .title-main { display: flex; align-items: center; gap: 0.6rem; }
    .title-icon {
      width: 34px; height: 34px; border-radius: 999px; background: #ffffff;
      display: flex; align-items: center; justify-content: center;
      font-size: 1.2rem; color: var(--primary);
      box-shadow: 0 3px 8px rgba(15, 23, 42, 0.18);
    }
    .title-text { display: flex; flex-direction: column; }
    .title-text strong { font-size: 1.02rem; }
    .title-text span { font-size: 0.76rem; color: var(--muted); }
    .month-picker { display: flex; flex-direction: column; gap: 0.18rem; font-size: 0.75rem; align-items: flex-end; white-space: nowrap; }
    .month-picker label { color: var(--muted); }
    .month-picker input[type="month"] {
      padding: 0.28rem 0.5rem; border-radius: 999px; border: 1px solid var(--border);
      font-size: 0.9rem; background: #ffffff;
    }
    .chips-row { display: flex; flex-wrap: wrap; gap: 0.4rem; margin-top: 0.2rem; }
    .chip {
      padding: 0.32rem 0.7rem; border-radius: 999px; background: var(--card-bg);
      border: 1px solid var(--border);
      display: flex; gap: 0.3rem; align-items: baseline;
      font-size: 0.76rem; box-shadow: 0 2px 6px rgba(15,23,42,0.12);
    }
    .chip strong { font-size: 0.78rem; }
    .chip.in { background: #ecfdf3; border-color: rgba(22,163,74,0.5); }
    .chip.out { background: #fef2f2; border-color: rgba(220,38,38,0.5); }
    .chip.balance-pos { background: #dcfce7; border-color: rgba(22,163,74,0.7); }
    .chip.balance-neg { background: #fee2e2; border-color: rgba(220,38,38,0.7); }
    main { margin-top: 0.4rem; }
    .card {
      background: var(--card-bg); border-radius: var(--radius); padding: 0.9rem;
      box-shadow: var(--shadow); border: 1px solid rgba(148,163,184,0.25);
      margin-bottom: 0.8rem;
    }
    .card-header { display: flex; justify-content: space-between; align-items: baseline; gap: 0.5rem; margin-bottom: 0.5rem; }
    .card-title { font-size: 0.96rem; font-weight: 600; }
    .card-subtitle { font-size: 0.74rem; color: var(--muted); margin-top: 0.1rem; }
    .card-tag {
      font-size: 0.7rem; padding: 0.18rem 0.5rem; border-radius: 999px;
      background: #e0f2fe; color: #1d4ed8; border: 1px solid #bfdbfe; white-space: nowrap;
    }
    .grid-2 { display: grid; grid-template-columns: 1fr; gap: 0.6rem; }
    @media (min-width: 720px) { .grid-2 { grid-template-columns: repeat(2, 1fr); } }
    .field-group { display: flex; flex-direction: column; gap: 0.25rem; margin-bottom: 0.35rem; }
    .field-group label { font-size: 0.76rem; color: var(--muted); }
    .field-group input, .field-group select, .field-group textarea {
      padding: 0.45rem 0.55rem; border-radius: 9px; border: 1px solid var(--border);
      font-size: 0.86rem; background: #ffffff; width: 100%;
    }
    .small-text { font-size: 0.74rem; color: var(--muted); }
    .btn {
      border: none; border-radius: 999px; padding: 0.45rem 0.9rem;
      font-size: 0.84rem; cursor: pointer;
      display: inline-flex; align-items: center; gap: 0.3rem;
      margin-top: 0.25rem; white-space: nowrap;
    }
    .btn-primary { background: var(--primary); color: #fff; }
    .btn-outline { background: transparent; color: var(--muted); border: 1px solid var(--border); }
    .btn-danger-chip {
      background: transparent; color: var(--danger);
      border: 1px solid rgba(220,38,38,0.5);
      border-radius: 999px; font-size: 0.72rem; padding: 0.18rem 0.5rem;
      cursor: pointer; display: inline-flex; align-items: center; gap: 0.2rem;
    }
    .pill-list { display: flex; flex-direction: column; gap: 0.25rem; margin-top: 0.3rem; max-height: 260px; overflow-y: auto; }
    .pill-item {
      display: flex; justify-content: space-between; align-items: center; gap: 0.5rem;
      padding: 0.3rem 0.6rem; border-radius: 999px;
      background: #f9fafb; border: 1px solid var(--border); font-size: 0.8rem;
    }
    .pill-main { display: flex; flex-direction: column; gap: 0.05rem; }
    .pill-line1 { font-weight: 500; }
    .pill-line2 { font-size: 0.7rem; color: var(--muted); }
    .expense-list { max-height: 260px; overflow-y: auto; margin-top: 0.3rem; }
    .expense-item {
      display: flex; justify-content: space-between; align-items: center; gap: 0.5rem;
      padding: 0.3rem 0.6rem; border-radius: 10px;
      background: #f9fafb; border: 1px solid var(--border); font-size: 0.8rem;
      margin-bottom: 0.25rem;
    }
    .expense-main { display: flex; flex-direction: column; gap: 0.05rem; }
    .expense-line1 { font-weight: 500; }
    .expense-line2 { font-size: 0.7rem; color: var(--muted); }
    .amount-neg { color: var(--danger); font-weight: 600; }
    .notes-box { width: 100%; min-height: 80px; resize: vertical; }

    .tabs-container { margin-bottom: 0.3rem; }
    .tab-section { display: none; }
    .tab-section.active { display: block; }

    .bottom-nav {
      position: fixed; bottom: 0; left: 0; right: 0; z-index: 30;
      background: rgba(15,23,42,0.9); backdrop-filter: blur(12px);
      padding: 0.2rem 0.3rem calc(0.3rem + env(safe-area-inset-bottom, 0));
      border-top: 1px solid rgba(148,163,184,0.6);
    }
    .bottom-nav-inner { max-width: 900px; margin: 0 auto; display: flex; justify-content: space-between; gap: 0.3rem; }
    .tab-btn {
      flex: 1; border: none; background: transparent; color: #e5e7eb;
      padding: 0.3rem 0.2rem 0.2rem; display: flex; flex-direction: column;
      align-items: center; gap: 0.1rem; font-size: 0.7rem; border-radius: 999px;
    }
    .tab-btn-icon {
      width: 22px; height: 22px; border-radius: 999px; border: 1px solid transparent;
      display: flex; align-items: center; justify-content: center; font-size: 1rem;
    }
    .tab-btn span.label { font-size: 0.68rem; opacity: 0.8; }
    .tab-btn.active { background: rgba(37,99,235,0.18); color: #ffffff; }
    .tab-btn.active .tab-btn-icon { border-color: rgba(191,219,254,0.9); background: rgba(37,99,235,0.3); }
    .warn-box {
      background: #fef3c7; border-radius: 10px; border: 1px solid #facc15;
      padding: 0.45rem 0.6rem; font-size: 0.75rem; color: #92400e; margin-top: 0.3rem;
    }
  </style>
</head>
<body>
  <header>
    <div class="header-inner">
      <div class="title-row">
        <div class="title-main">
          <div class="title-icon">‚Ç¨</div>
          <div class="title-text">
            <strong>Econom√≠a Familiar</strong>
            <span>Diario de gastos ¬∑ v5d</span>
          </div>
        </div>
        <div class="month-picker">
          <label for="monthSelector">Mes en curso</label>
          <input type="month" id="monthSelector" />
        </div>
      </div>
      <div class="chips-row">
        <div class="chip in">
          <span>Entradas</span>
          <strong id="chipIngresos">0 ‚Ç¨</strong>
        </div>
        <div class="chip out">
          <span>Gastos</span>
          <strong id="chipGastos">0 ‚Ç¨</strong>
        </div>
        <div class="chip balance-pos" id="chipBalanceWrap">
          <span>Balance</span>
          <strong id="chipBalance">0 ‚Ç¨</strong>
        </div>
      </div>
    </div>
  </header>

  <div class="app">
    <main class="tabs-container">
      <!-- INGRESOS -->
      <section class="tab-section active" data-tab="ingresos">
        <section class="card">
          <div class="card-header">
            <div>
              <div class="card-title">Ingresos base mensuales</div>
              <div class="card-subtitle">
                Sueldos fijos de Juan y Saray. Se guardan solo en este dispositivo.
              </div>
            </div>
            <div class="card-tag">Ingresos</div>
          </div>
          <div class="grid-2">
            <div>
              <div class="field-group">
                <label>Juan (‚Ç¨ / mes)</label>
                <input type="number" id="ingJuan" step="0.01" inputmode="decimal" />
              </div>
              <div class="field-group">
                <label>Saray (‚Ç¨ / mes)</label>
                <input type="number" id="ingSaray" step="0.01" inputmode="decimal" />
              </div>
            </div>
            <div>
              <div class="field-group">
                <label>Otros ingresos fijos (‚Ç¨ / mes)</label>
                <input type="number" id="ingOtros" step="0.01" inputmode="decimal" />
              </div>
              <button class="btn btn-primary" id="btnSaveIngresos">üíæ Guardar ingresos base</button>
              <div class="small-text" style="margin-top:0.28rem;">
                Por defecto empiezan en 0. Solo t√∫ los rellenas.
              </div>
            </div>
          </div>
        </section>

        <section class="card">
          <div class="card-header">
            <div>
              <div class="card-title">Resumen r√°pido del mes</div>
              <div class="card-subtitle">
                Ingresos ‚Äì gastos fijos globales ‚Äì gastos diarios.
              </div>
            </div>
            <div class="card-tag">Resumen</div>
          </div>
          <div class="grid-2">
            <div>
              <div class="field-group">
                <label>Ingresos totales</label>
                <div id="resIngMes" class="small-text">0 ‚Ç¨</div>
              </div>
              <div class="field-group">
                <label>Gastos fijos globales</label>
                <div id="resFijosMes" class="small-text">0 ‚Ç¨</div>
              </div>
            </div>
            <div>
              <div class="field-group">
                <label>Gastos variables</label>
                <div id="resVarMes" class="small-text">0 ‚Ç¨</div>
              </div>
              <div class="field-group">
                <label>Balance del mes</label>
                <div id="resBalMes" class="small-text">0 ‚Ç¨</div>
              </div>
            </div>
          </div>
        </section>
      </section>

      <!-- GASTOS -->
      <section class="tab-section" data-tab="gastos">
        <section class="card">
          <div class="card-header">
            <div>
              <div class="card-title">Gasto del d√≠a</div>
              <div class="card-subtitle">
                Apunta cada compra. As√≠ ves en qu√© se va el dinero.
              </div>
            </div>
            <div class="card-tag">Gastos</div>
          </div>
          <div class="grid-2">
            <div>
              <div class="field-group">
                <label>Fecha</label>
                <input type="date" id="gastoFecha" />
              </div>
              <div class="field-group">
                <label>Categor√≠a</label>
                <input list="catSugerencias" id="gastoCategoria" placeholder="Alimentaci√≥n, Ocio, Huchas..." />
                <datalist id="catSugerencias"></datalist>
              </div>
            </div>
            <div>
              <div class="field-group">
                <label>Descripci√≥n</label>
                <input type="text" id="gastoDesc" placeholder="Lidl, gasolina, cine..." />
              </div>
              <div class="field-group">
                <label>Importe (‚Ç¨)</label>
                <input type="number" id="gastoImporte" step="0.01" inputmode="decimal" />
              </div>
              <button class="btn btn-primary" id="btnAddGasto">‚ûï Guardar gasto</button>
            </div>
          </div>
        </section>

        <section class="card">
          <div class="card-header">
            <div>
              <div class="card-title">Gastos del mes seleccionado</div>
              <div class="card-subtitle">
                Filtrados autom√°ticamente por el mes elegido en la cabecera.
              </div>
            </div>
            <div class="card-tag">Listado</div>
          </div>
          <div id="gastosLista" class="expense-list"></div>
        </section>
      </section>

      <!-- SOBRES -->
      <section class="tab-section" data-tab="sobres">
        <section class="card">
          <div class="card-header">
            <div>
              <div class="card-title">Presupuestos mensuales (sobres)</div>
              <div class="card-subtitle">
                Marca cu√°nto quer√©is gastar en cada categor√≠a. Empiezan todos en 0.
              </div>
            </div>
            <div class="card-tag">Sobres</div>
          </div>
          <div class="grid-2">
            <div>
              <div class="field-group">
                <label>Nombre del sobre</label>
                <input type="text" id="sobreNombre" placeholder="Alimentaci√≥n, Ocio..." />
              </div>
            </div>
            <div>
              <div class="field-group">
                <label>Presupuesto mensual (‚Ç¨)</label>
                <input type="number" id="sobreImporte" step="0.01" inputmode="decimal" />
              </div>
              <button class="btn btn-primary" id="btnAddSobre">üíæ Guardar sobre</button>
            </div>
          </div>
          <div class="small-text">
            Puedes crear Alimentaci√≥n 600, Ocio, Ni√±os, etc. t√∫ mismo. No vienen en el c√≥digo.
          </div>
        </section>

        <section class="card">
          <div class="card-header">
            <div>
              <div class="card-title">Estado de los sobres</div>
              <div class="card-subtitle">
                Gastado vs presupuesto para el mes seleccionado.
              </div>
            </div>
            <div class="card-tag">Detalle</div>
          </div>
          <div id="sobresLista" class="pill-list"></div>
        </section>
      </section>

      <!-- HUCHAS -->
      <section class="tab-section" data-tab="huchas">
        <section class="card">
          <div class="card-header">
            <div>
              <div class="card-title">Huchas de ahorro</div>
              <div class="card-subtitle">
                Dinero que vais guardando para objetivos concretos (viajes, Black Friday, Navidad...).
              </div>
            </div>
            <div class="card-tag">Huchas</div>
          </div>
          <div class="grid-2">
            <div>
              <div class="field-group">
                <label>Nombre de la hucha</label>
                <input type="text" id="huchaNombre" placeholder="Black Friday, Viaje, PS5..." />
              </div>
              <div class="field-group">
                <label>Objetivo (‚Ç¨) (opcional)</label>
                <input type="number" id="huchaObjetivo" step="0.01" inputmode="decimal" />
              </div>
            </div>
            <div>
              <div class="field-group">
                <label>Saldo inicial (opcional)</label>
                <input type="number" id="huchaSaldoInicial" step="0.01" inputmode="decimal" />
              </div>
              <button class="btn btn-primary" id="btnAddHucha">‚ûï Crear hucha</button>
            </div>
          </div>
        </section>

        <section class="card">
          <div class="card-header">
            <div>
              <div class="card-title">Movimientos en huchas</div>
              <div class="card-subtitle">
                Aportar cuenta como gasto en la categor√≠a Huchas. Retirar solo baja el saldo guardado.
              </div>
            </div>
            <div class="card-tag">Movimientos</div>
          </div>
          <div class="grid-2">
            <div>
              <div class="field-group">
                <label>Hucha</label>
                <select id="huchaSelect">
                  <option value="">-- Elige hucha --</option>
                </select>
              </div>
              <div class="field-group">
                <label>Importe (‚Ç¨)</label>
                <input type="number" id="huchaImporte" step="0.01" inputmode="decimal" />
              </div>
            </div>
            <div>
              <div class="field-group">
                <label>Acci√≥n</label>
                <select id="huchaAccion">
                  <option value="aportar">Aportar (ahorrar)</option>
                  <option value="retirar">Retirar (usar la hucha)</option>
                </select>
              </div>
              <button class="btn btn-primary" id="btnHuchaMovimiento">üí∞ Registrar movimiento</button>
              <div class="small-text" style="margin-top:0.3rem;">
                ¬∑ Aportar: sube saldo y crea un gasto en <b>Huchas</b>.<br />
                ¬∑ Retirar: solo baja saldo, el gasto ya se contabiliz√≥ al ahorrar.
              </div>
            </div>
          </div>
        </section>

        <section class="card">
          <div class="card-header">
            <div>
              <div class="card-title">Listado de huchas</div>
              <div class="card-subtitle">
                Saldo actual, objetivo y progreso.
              </div>
            </div>
            <div class="card-tag">Listado</div>
          </div>
          <div id="huchasLista" class="pill-list"></div>
        </section>
      </section>

      <!-- CONFIG -->
      <section class="tab-section" data-tab="config">
        <section class="card">
          <div class="card-header">
            <div>
              <div class="card-title">Gastos fijos globales</div>
              <div class="card-subtitle">
                Suma de alquiler, luz, seguros, pr√©stamo, etc. Solo se usa para el resumen.
              </div>
            </div>
            <div class="card-tag">Fijos</div>
          </div>
          <div class="field-group">
            <label>Gastos fijos totales (‚Ç¨ / mes)</label>
            <input type="number" id="fijosGlobales" step="0.01" inputmode="decimal" />
          </div>
          <button class="btn btn-primary" id="btnSaveFijos">üíæ Guardar fijos globales</button>
          <div class="small-text" style="margin-top:0.3rem;">
            Aqu√≠ puedes poner, por ejemplo, 1.014 ‚Ç¨ o la cifra que mejor se ajuste a tus gastos fijos.
          </div>
        </section>

        <section class="card">
          <div class="card-header">
            <div>
              <div class="card-title">Importar movimientos desde CSV</div>
              <div class="card-subtitle">
                Lee el CSV de CaixaBank (Concepto, Fecha, Importe, Saldo) y crea gastos autom√°ticamente.
              </div>
            </div>
            <div class="card-tag">CSV</div>
          </div>
          <div class="grid-2">
            <div>
              <div class="field-group">
                <label>Archivo CSV de CaixaBank</label>
                <input type="file" id="csvFile" accept=".csv,text/csv" />
              </div>
            </div>
            <div>
              <button class="btn btn-primary" id="btnImportCsv">üì§ Importar CSV como gastos</button>
              <div class="small-text" style="margin-top:0.3rem;">
                Solo se importan las l√≠neas con importe negativo (cargos). El concepto del banco va en la descripci√≥n.
              </div>
            </div>
          </div>
        </section>

        <section class="card">
          <div class="card-header">
            <div>
              <div class="card-title">Copia de seguridad</div>
              <div class="card-subtitle">
                Exporta e importa todos los datos con un JSON. No se env√≠a nada a ning√∫n servidor.
              </div>
            </div>
            <div class="card-tag">Backup</div>
          </div>
          <div class="grid-2">
            <div>
              <button class="btn btn-primary" id="btnExportJson">üì• Descargar JSON</button>
              <div class="small-text" style="margin-top:0.3rem;">
                Guarda este archivo en iCloud, WD, correo, etc. para recuperarlo si cambias de m√≥vil.
              </div>
            </div>
            <div>
              <div class="field-group">
                <label>Importar desde archivo JSON</label>
                <input type="file" id="importFile" accept="application/json,.json" />
              </div>
              <button class="btn btn-outline" id="btnImportJsonFile">üì§ Importar desde archivo</button>
            </div>
          </div>
          <div class="field-group" style="margin-top:0.6rem;">
            <label>O pegar el contenido del JSON aqu√≠</label>
            <textarea id="importJsonText" class="notes-box" placeholder="Pega aqu√≠ el contenido del JSON de tu copia de seguridad..."></textarea>
          </div>
          <button class="btn btn-primary" id="btnImportJsonText">üì§ Importar desde texto</button>
          <div class="warn-box">
            Al importar se sobrescriben los datos actuales (ingresos, sobres, huchas, gastos y notas).
          </div>
        </section>

        <section class="card">
          <div class="card-header">
            <div>
              <div class="card-title">Notas del mes</div>
              <div class="card-subtitle">
                Comentarios o recordatorios sobre el mes seleccionado.
              </div>
            </div>
            <div class="card-tag">Notas</div>
          </div>
          <div class="field-group">
            <textarea id="notasMes" class="notes-box" placeholder="Ej: Este mes subi√≥ la comida por compra grande..."></textarea>
          </div>
          <button class="btn btn-primary" id="btnSaveNotas">üíæ Guardar notas</button>
        </section>

        <section class="card">
          <div class="card-header">
            <div>
              <div class="card-title">Opciones avanzadas</div>
              <div class="card-subtitle">
                Solo usar si quieres empezar completamente de cero.
              </div>
            </div>
            <div class="card-tag">Peligroso</div>
          </div>
          <button class="btn btn-outline" id="btnResetAll">üß® Borrar todos los datos y reiniciar</button>
          <div class="small-text" style="margin-top:0.3rem;">
            Esto borra todo lo guardado en este dispositivo (localStorage) y vuelve a los valores por defecto (todo a 0).
          </div>
        </section>
      </section>
    </main>
  </div>

  <nav class="bottom-nav">
    <div class="bottom-nav-inner">
      <button class="tab-btn active" data-tab-target="ingresos">
        <div class="tab-btn-icon">üí∂</div>
        <span class="label">Ingresos</span>
      </button>
      <button class="tab-btn" data-tab-target="gastos">
        <div class="tab-btn-icon">üìâ</div>
        <span class="label">Gastos</span>
      </button>
      <button class="tab-btn" data-tab-target="sobres">
        <div class="tab-btn-icon">üì©</div>
        <span class="label">Sobres</span>
      </button>
      <button class="tab-btn" data-tab-target="huchas">
        <div class="tab-btn-icon">üê∑</div>
        <span class="label">Huchas</span>
      </button>
      <button class="tab-btn" data-tab-target="config">
        <div class="tab-btn-icon">‚öôÔ∏è</div>
        <span class="label">Config</span>
      </button>
    </div>
  </nav>

  <script>
    function formatCurrency(num) {
      var n = Number(num) || 0;
      return n.toLocaleString("es-ES", {
        style: "currency",
        currency: "EUR",
        minimumFractionDigits: 2
      });
    }

    function loadJSON(key, fallback) {
      try {
        var raw = localStorage.getItem(key);
        if (!raw) return fallback;
        return JSON.parse(raw);
      } catch (e) {
        console.error("loadJSON error", key, e);
        return fallback;
      }
    }

    function saveJSON(key, value) {
      try {
        localStorage.setItem(key, JSON.stringify(value));
      } catch (e) {
        console.error("saveJSON error", key, e);
      }
    }

    var LS_KEYS = {
      BASE: "eco_base",
      SOBRES: "eco_sobres",
      HUCHAS: "eco_huchas",
      GASTOS: "eco_gastos",
      NOTAS: "eco_notas",
      FIJOS_GLOBALES: "eco_fijos_globales"
    };

    var DEFAULT_BASE = { juan: 0, saray: 0, otros: 0 };
    var baseConfig = loadJSON(LS_KEYS.BASE, DEFAULT_BASE);
    var sobres = loadJSON(LS_KEYS.SOBRES, {});
    var huchas = loadJSON(LS_KEYS.HUCHAS, []);
    var gastos = loadJSON(LS_KEYS.GASTOS, []);
    var notasByMonth = loadJSON(LS_KEYS.NOTAS, {});
    var fijosGlobalesValor = loadJSON(LS_KEYS.FIJOS_GLOBALES, 0);

    var monthSelector = document.getElementById("monthSelector");
    var chipIngresos = document.getElementById("chipIngresos");
    var chipGastos = document.getElementById("chipGastos");
    var chipBalance = document.getElementById("chipBalance");
    var chipBalanceWrap = document.getElementById("chipBalanceWrap");

    var ingJuanInput = document.getElementById("ingJuan");
    var ingSarayInput = document.getElementById("ingSaray");
    var ingOtrosInput = document.getElementById("ingOtros");
    var btnSaveIngresos = document.getElementById("btnSaveIngresos");

    var resIngMesDiv = document.getElementById("resIngMes");
    var resFijosMesDiv = document.getElementById("resFijosMes");
    var resVarMesDiv = document.getElementById("resVarMes");
    var resBalMesDiv = document.getElementById("resBalMes");

    var gastoFechaInput = document.getElementById("gastoFecha");
    var gastoCategoriaInput = document.getElementById("gastoCategoria");
    var gastoDescInput = document.getElementById("gastoDesc");
    var gastoImporteInput = document.getElementById("gastoImporte");
    var btnAddGasto = document.getElementById("btnAddGasto");
    var gastosListaDiv = document.getElementById("gastosLista");
    var catSugerencias = document.getElementById("catSugerencias");

    var sobreNombreInput = document.getElementById("sobreNombre");
    var sobreImporteInput = document.getElementById("sobreImporte");
    var btnAddSobre = document.getElementById("btnAddSobre");
    var sobresListaDiv = document.getElementById("sobresLista");

    var huchaNombreInput = document.getElementById("huchaNombre");
    var huchaObjetivoInput = document.getElementById("huchaObjetivo");
    var huchaSaldoInicialInput = document.getElementById("huchaSaldoInicial");
    var btnAddHucha = document.getElementById("btnAddHucha");
    var huchaSelect = document.getElementById("huchaSelect");
    var huchaImporteInput = document.getElementById("huchaImporte");
    var huchaAccionSelect = document.getElementById("huchaAccion");
    var btnHuchaMovimiento = document.getElementById("btnHuchaMovimiento");
    var huchasListaDiv = document.getElementById("huchasLista");

    var notasMesTextarea = document.getElementById("notasMes");
    var btnSaveNotas = document.getElementById("btnSaveNotas");

    var fijosGlobalesInput = document.getElementById("fijosGlobales");
    var btnSaveFijos = document.getElementById("btnSaveFijos");

    var btnExportJson = document.getElementById("btnExportJson");
    var importFileInput = document.getElementById("importFile");
    var btnImportJsonFile = document.getElementById("btnImportJsonFile");
    var importJsonTextArea = document.getElementById("importJsonText");
    var btnImportJsonText = document.getElementById("btnImportJsonText");
    var btnResetAll = document.getElementById("btnResetAll");

    var csvFileInput = document.getElementById("csvFile");
    var btnImportCsv = document.getElementById("btnImportCsv");

    function currentMonthKey() {
      return monthSelector.value || new Date().toISOString().slice(0, 7);
    }

    function gastosDelMes(mes) {
      var out = [];
      for (var i = 0; i < gastos.length; i++) {
        if (gastos[i].mes === mes) out.push(gastos[i]);
      }
      return out;
    }

    function refreshCategorySuggestions() {
      if (!catSugerencias) return;
      while (catSugerencias.firstChild) catSugerencias.removeChild(catSugerencias.firstChild);
      var set = {};
      for (var cat in sobres) { if (sobres.hasOwnProperty(cat)) set[cat] = true; }
      set["Huchas"] = true;
      for (var i = 0; i < huchas.length; i++) { set[huchas[i].nombre] = true; }
      for (var name in set) {
        if (!set.hasOwnProperty(name)) continue;
        var opt = document.createElement("option");
        opt.value = name;
        catSugerencias.appendChild(opt);
      }
    }

    function renderIngresosForm() {
      ingJuanInput.value = baseConfig.juan || "";
      ingSarayInput.value = baseConfig.saray || "";
      ingOtrosInput.value = baseConfig.otros || "";
    }

    function renderResumen(mes) {
      var ingresosMes = (baseConfig.juan || 0) + (baseConfig.saray || 0) + (baseConfig.otros || 0);
      var lista = gastosDelMes(mes);
      var totalVar = 0;
      for (var i = 0; i < lista.length; i++) totalVar += lista[i].importe || 0;
      var totalFijos = Number(fijosGlobalesValor) || 0;
      var balance = ingresosMes - totalFijos - totalVar;

      chipIngresos.textContent = formatCurrency(ingresosMes);
      chipGastos.textContent = formatCurrency(totalFijos + totalVar);
      chipBalance.textContent = formatCurrency(balance);
      if (balance >= 0) {
        chipBalanceWrap.classList.remove("balance-neg");
        chipBalanceWrap.classList.add("balance-pos");
      } else {
        chipBalanceWrap.classList.remove("balance-pos");
        chipBalanceWrap.classList.add("balance-neg");
      }

      resIngMesDiv.textContent = formatCurrency(ingresosMes);
      resFijosMesDiv.textContent = formatCurrency(totalFijos);
      resVarMesDiv.textContent = formatCurrency(totalVar);
      resBalMesDiv.textContent = formatCurrency(balance);
    }

    function renderGastos(mes) {
      while (gastosListaDiv.firstChild) gastosListaDiv.removeChild(gastosListaDiv.firstChild);
      var lista = gastosDelMes(mes);
      if (!lista.length) {
        var p = document.createElement("div");
        p.className = "small-text";
        p.textContent = "Todav√≠a no hay gastos apuntados en este mes.";
        gastosListaDiv.appendChild(p);
        return;
      }
      lista.sort(function(a, b){ return a.fecha.localeCompare(b.fecha); });
      for (var i = 0; i < lista.length; i++) {
        var g = lista[i];
        var item = document.createElement("div");
        item.className = "expense-item";

        var main = document.createElement("div");
        main.className = "expense-main";

        var l1 = document.createElement("div");
        l1.className = "expense-line1";
        l1.textContent = g.categoria + " ¬∑ ";
        var spanAmt = document.createElement("span");
        spanAmt.className = "amount-neg";
        spanAmt.textContent = formatCurrency(g.importe);
        l1.appendChild(spanAmt);

        var l2 = document.createElement("div");
        l2.className = "expense-line2";
        l2.textContent = g.fecha + " ¬∑ " + (g.desc || "");

        main.appendChild(l1);
        main.appendChild(l2);

        var btn = document.createElement("button");
        btn.className = "btn-danger-chip";
        btn.textContent = "‚úï";
        btn.setAttribute("data-type", "gasto");
        btn.setAttribute("data-id", g.id);

        item.appendChild(main);
        item.appendChild(btn);
        gastosListaDiv.appendChild(item);
      }
    }

    function renderSobres(mes) {
      while (sobresListaDiv.firstChild) sobresListaDiv.removeChild(sobresListaDiv.firstChild);
      var lista = gastosDelMes(mes);
      var porCat = {};
      for (var i = 0; i < lista.length; i++) {
        var g = lista[i];
        var cat = g.categoria || "Otros";
        if (!porCat[cat]) porCat[cat] = 0;
        porCat[cat] += g.importe || 0;
      }
      var cats = Object.keys(sobres);
      if (!cats.length) {
        var p = document.createElement("div");
        p.className = "small-text";
        p.textContent = "Crea tus primeros sobres para controlar presupuestos.";
        sobresListaDiv.appendChild(p);
        return;
      }
      for (var c = 0; c < cats.length; c++) {
        var catName = cats[c];
        var presup = sobres[catName] || 0;
        var gast = porCat[catName] || 0;
        var restante = presup - gast;

        var item = document.createElement("div");
        item.className = "pill-item";

        var main = document.createElement("div");
        main.className = "pill-main";

        var l1 = document.createElement("div");
        l1.className = "pill-line1";
        l1.textContent = catName;

        var l2 = document.createElement("div");
        l2.className = "pill-line2";
        var estado = "";
        if (presup === 0 && gast === 0) {
          estado = "Sin presupuesto marcado todav√≠a.";
        } else if (restante >= 0) {
          estado = "Quedan " + formatCurrency(restante);
        } else {
          estado = "Te pasas " + formatCurrency(-restante);
        }
        l2.textContent = "Presupuesto: " + formatCurrency(presup) +
          " ¬∑ Gastado: " + formatCurrency(gast) + " ¬∑ " + estado;

        main.appendChild(l1);
        main.appendChild(l2);

        var btn = document.createElement("button");
        btn.className = "btn-danger-chip";
        btn.textContent = "‚úï";
        btn.setAttribute("data-type", "sobre");
        btn.setAttribute("data-id", catName);

        item.appendChild(main);
        item.appendChild(btn);
        sobresListaDiv.appendChild(item);
      }
    }

    function renderHuchas() {
      while (huchasListaDiv.firstChild) huchasListaDiv.removeChild(huchasListaDiv.firstChild);
      while (huchaSelect.firstChild) huchaSelect.removeChild(huchaSelect.firstChild);
      var opt0 = document.createElement("option");
      opt0.value = "";
      opt0.textContent = "-- Elige hucha --";
      huchaSelect.appendChild(opt0);

      if (!huchas.length) {
        var p = document.createElement("div");
        p.className = "small-text";
        p.textContent = "Crea tu primera hucha: por ejemplo Black Friday, Viaje o Navidad.";
        huchasListaDiv.appendChild(p);
        refreshCategorySuggestions();
        return;
      }

      for (var i = 0; i < huchas.length; i++) {
        var h = huchas[i];
        var objetivo = h.objetivo || 0;
        var saldo = h.saldo || 0;
        var detalle = "Saldo: " + formatCurrency(saldo);
        if (objetivo > 0) {
          var pct = Math.min(100, Math.round((saldo / objetivo) * 100));
          detalle += " ¬∑ Objetivo: " + formatCurrency(objetivo) + " (" + pct + "%)";
        }

        var item = document.createElement("div");
        item.className = "pill-item";

        var main = document.createElement("div");
        main.className = "pill-main";

        var l1 = document.createElement("div");
        l1.className = "pill-line1";
        l1.textContent = h.nombre;

        var l2 = document.createElement("div");
        l2.className = "pill-line2";
        l2.textContent = detalle;

        main.appendChild(l1);
        main.appendChild(l2);

        var btn = document.createElement("button");
        btn.className = "btn-danger-chip";
        btn.textContent = "‚úï";
        btn.setAttribute("data-type", "hucha");
        btn.setAttribute("data-id", h.id);

        item.appendChild(main);
        item.appendChild(btn);
        huchasListaDiv.appendChild(item);

        var opt = document.createElement("option");
        opt.value = h.id;
        opt.textContent = h.nombre;
        huchaSelect.appendChild(opt);
      }
      refreshCategorySuggestions();
    }

    function renderNotas(mes) {
      notasMesTextarea.value = notasByMonth[mes] || "";
    }

    function renderFijosInput() {
      fijosGlobalesInput.value = fijosGlobalesValor || "";
    }

    function renderAll() {
      var mes = currentMonthKey();
      renderIngresosForm();
      renderResumen(mes);
      renderGastos(mes);
      renderSobres(mes);
      renderHuchas();
      renderNotas(mes);
      renderFijosInput();
    }

    if (btnSaveIngresos) {
      btnSaveIngresos.addEventListener("click", function () {
        baseConfig.juan = parseFloat(ingJuanInput.value) || 0;
        baseConfig.saray = parseFloat(ingSarayInput.value) || 0;
        baseConfig.otros = parseFloat(ingOtrosInput.value) || 0;
        saveJSON(LS_KEYS.BASE, baseConfig);
        renderAll();
      });
    }

    if (btnSaveFijos) {
      btnSaveFijos.addEventListener("click", function () {
        fijosGlobalesValor = parseFloat(fijosGlobalesInput.value) || 0;
        saveJSON(LS_KEYS.FIJOS_GLOBALES, fijosGlobalesValor);
        renderAll();
      });
    }

    if (btnAddGasto) {
      btnAddGasto.addEventListener("click", function () {
        var fecha = gastoFechaInput.value || new Date().toISOString().slice(0, 10);
        var mes = fecha.slice(0, 7);
        var categoria = (gastoCategoriaInput.value || "").trim() || "Otros";
        var desc = (gastoDescInput.value || "").trim();
        var importe = parseFloat(gastoImporteInput.value);
        if (!importe || isNaN(importe)) return;
        gastos.push({
          id: Date.now().toString() + Math.random().toString(16).slice(2),
          fecha: fecha,
          mes: mes,
          categoria: categoria,
          desc: desc,
          importe: importe
        });
        saveJSON(LS_KEYS.GASTOS, gastos);
        gastoDescInput.value = "";
        gastoImporteInput.value = "";
        renderAll();
      });
    }

    if (btnAddSobre) {
      btnAddSobre.addEventListener("click", function () {
        var nombre = (sobreNombreInput.value || "").trim();
        var importe = parseFloat(sobreImporteInput.value) || 0;
        if (!nombre) return;
        sobres[nombre] = importe;
        saveJSON(LS_KEYS.SOBRES, sobres);
        sobreNombreInput.value = "";
        sobreImporteInput.value = "";
        renderAll();
      });
    }

    if (btnAddHucha) {
      btnAddHucha.addEventListener("click", function () {
        var nombre = (huchaNombreInput.value || "").trim();
        var objetivo = parseFloat(huchaObjetivoInput.value) || 0;
        var saldoInicial = parseFloat(huchaSaldoInicialInput.value) || 0;
        if (!nombre) return;
        huchas.push({
          id: Date.now().toString() + Math.random().toString(16).slice(2),
          nombre: nombre,
          objetivo: objetivo,
          saldo: saldoInicial
        });
        saveJSON(LS_KEYS.HUCHAS, huchas);
        huchaNombreInput.value = "";
        huchaObjetivoInput.value = "";
        huchaSaldoInicialInput.value = "";
        renderAll();
      });
    }

    if (btnHuchaMovimiento) {
      btnHuchaMovimiento.addEventListener("click", function () {
        var id = huchaSelect.value;
        var importe = parseFloat(huchaImporteInput.value);
        var accion = huchaAccionSelect.value || "aportar";
        if (!id || !importe || isNaN(importe)) return;
        var h = null;
        for (var i = 0; i < huchas.length; i++) {
          if (huchas[i].id === id) { h = huchas[i]; break; }
        }
        if (!h) return;
        var hoy = new Date().toISOString().slice(0, 10);
        var mes = hoy.slice(0, 7);
        if (accion === "aportar") {
          h.saldo = (h.saldo || 0) + importe;
          gastos.push({
            id: Date.now().toString() + Math.random().toString(16).slice(2),
            fecha: hoy,
            mes: mes,
            categoria: "Huchas",
            desc: "Aporte hucha " + h.nombre,
            importe: importe
          });
        } else {
          h.saldo = (h.saldo || 0) - importe;
          if (h.saldo < 0) h.saldo = 0;
        }
        saveJSON(LS_KEYS.HUCHAS, huchas);
        saveJSON(LS_KEYS.GASTOS, gastos);
        huchaImporteInput.value = "";
        renderAll();
      });
    }

    if (btnSaveNotas) {
      btnSaveNotas.addEventListener("click", function () {
        var mes = currentMonthKey();
        notasByMonth[mes] = notasMesTextarea.value || "";
        saveJSON(LS_KEYS.NOTAS, notasByMonth);
      });
    }

    document.addEventListener("click", function (e) {
      var btn = e.target.closest ? e.target.closest("button.btn-danger-chip") : null;
      if (!btn) return;
      var type = btn.getAttribute("data-type");
      var id = btn.getAttribute("data-id");
      if (!type || !id) return;
      if (type === "gasto") {
        gastos = gastos.filter(function (g) { return g.id !== id; });
        saveJSON(LS_KEYS.GASTOS, gastos);
      } else if (type === "sobre") {
        delete sobres[id];
        saveJSON(LS_KEYS.SOBRES, sobres);
      } else if (type === "hucha") {
        huchas = huchas.filter(function (h) { return h.id !== id; });
        saveJSON(LS_KEYS.HUCHAS, huchas);
      }
      renderAll();
    });

    var tabButtons = document.querySelectorAll(".tab-btn");
    var tabSections = document.querySelectorAll(".tab-section");

    for (var iTab = 0; iTab < tabButtons.length; iTab++) {
      (function (btn) {
        btn.addEventListener("click", function () {
          var target = btn.getAttribute("data-tab-target");
          for (var j = 0; j < tabButtons.length; j++) {
            tabButtons[j].classList.remove("active");
          }
          btn.classList.add("active");
          for (var k = 0; k < tabSections.length; k++) {
            var sec = tabSections[k];
            if (sec.getAttribute("data-tab") === target) {
              sec.classList.add("active");
            } else {
              sec.classList.remove("active");
            }
          }
        });
      })(tabButtons[iTab]);
    }

    if (monthSelector) {
      monthSelector.addEventListener("change", function () {
        renderAll();
      });
    }

    if (btnExportJson) {
      btnExportJson.addEventListener("click", function () {
        var payload = {
          meta: { app: "eco-familiar-v5d", exportedAt: new Date().toISOString() },
          baseConfig: baseConfig,
          sobres: sobres,
          huchas: huchas,
          gastos: gastos,
          notasByMonth: notasByMonth,
          fijosGlobales: fijosGlobalesValor
        };
        var blob = new Blob([JSON.stringify(payload, null, 2)], { type: "application/json" });
        var url = URL.createObjectURL(blob);
        var a = document.createElement("a");
        var today = new Date().toISOString().slice(0, 10);
        a.href = url;
        a.download = "eco_familiar_backup_" + today + ".json";
        document.body.appendChild(a);
        a.click();
        setTimeout(function () {
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
        }, 0);
      });
    }

    if (btnImportJsonFile && importFileInput) {
      btnImportJsonFile.addEventListener("click", function () {
        var file = importFileInput.files && importFileInput.files[0];
        if (!file) return;
        var reader = new FileReader();
        reader.onload = function (ev) {
          try {
            var data = JSON.parse(ev.target.result);
            applyBackupPayload(data);
            alert("Datos importados correctamente desde archivo.");
          } catch (err) {
            console.error(err);
            alert("No se ha podido importar el JSON. Revisa que sea una copia v√°lida.");
          }
        };
        reader.readAsText(file, "utf-8");
      });
    }

    if (btnImportJsonText) {
      btnImportJsonText.addEventListener("click", function () {
        var txt = importJsonTextArea.value || "";
        if (!txt.trim()) return;
        try {
          var data = JSON.parse(txt);
          applyBackupPayload(data);
          alert("Datos importados correctamente desde texto.");
        } catch (err) {
          console.error(err);
          alert("El texto pegado no es un JSON v√°lido o no corresponde a la app.");
        }
      });
    }

    function applyBackupPayload(data) {
      if (!data || typeof data !== "object") throw new Error("Formato inv√°lido");
      if (data.baseConfig) baseConfig = data.baseConfig;
      if (data.sobres) sobres = data.sobres;
      if (Array.isArray(data.huchas)) huchas = data.huchas;
      if (Array.isArray(data.gastos)) gastos = data.gastos;
      if (data.notasByMonth) notasByMonth = data.notasByMonth;
      if (typeof data.fijosGlobales !== "undefined") fijosGlobalesValor = data.fijosGlobales;

      saveJSON(LS_KEYS.BASE, baseConfig);
      saveJSON(LS_KEYS.SOBRES, sobres);
      saveJSON(LS_KEYS.HUCHAS, huchas);
      saveJSON(LS_KEYS.GASTOS, gastos);
      saveJSON(LS_KEYS.NOTAS, notasByMonth);
      saveJSON(LS_KEYS.FIJOS_GLOBALES, fijosGlobalesValor);

      refreshCategorySuggestions();
      renderAll();
    }

    if (btnResetAll) {
      btnResetAll.addEventListener("click", function () {
        var ok = confirm("Esto borrar√° todos los datos guardados en este dispositivo y volver√° a los valores iniciales (todo a 0). ¬øSeguro?");
        if (!ok) return;
        baseConfig = { juan: 0, saray: 0, otros: 0 };
        sobres = {};
        huchas = [];
        gastos = [];
        notasByMonth = {};
        fijosGlobalesValor = 0;
        saveJSON(LS_KEYS.BASE, baseConfig);
        saveJSON(LS_KEYS.SOBRES, sobres);
        saveJSON(LS_KEYS.HUCHAS, huchas);
        saveJSON(LS_KEYS.GASTOS, gastos);
        saveJSON(LS_KEYS.NOTAS, notasByMonth);
        saveJSON(LS_KEYS.FIJOS_GLOBALES, fijosGlobalesValor);
        refreshCategorySuggestions();
        renderAll();
      });
    }

    if (btnImportCsv && csvFileInput) {
      btnImportCsv.addEventListener("click", function () {
        var file = csvFileInput.files && csvFileInput.files[0];
        if (!file) return;
        var reader = new FileReader();
        reader.onload = function (ev) {
          try {
            var text = ev.target.result || "";
            var lines = text.split(/\r?\n/);
            if (!lines.length) return;
            var header = lines[0].split(";");
            var idxConcepto = header.indexOf("Concepto");
            var idxFecha = header.indexOf("Fecha");
            var idxImporte = header.indexOf("Importe");
            if (idxConcepto === -1 || idxFecha === -1 || idxImporte === -1) {
              alert("El CSV no parece tener las columnas Concepto;Fecha;Importe...");
              return;
            }
            var imported = 0;
            for (var i = 1; i < lines.length; i++) {
              var line = lines[i];
              if (!line || !line.trim()) continue;
              var cols = line.split(";");
              if (cols.length < header.length) continue;
              var concepto = (cols[idxConcepto] || "").trim();
              var fechaStr = (cols[idxFecha] || "").trim();
              var impStr = (cols[idxImporte] || "").trim();

              if (!fechaStr || !impStr) continue;

              var parts = fechaStr.split("/");
              var iso;
              if (parts.length === 3) {
                var d = parts[0]; if (d.length === 1) d = "0" + d;
                var m = parts[1]; if (m.length === 1) m = "0" + m;
                var y = parts[2];
                iso = y + "-" + m + "-" + d;
              } else {
                iso = new Date().toISOString().slice(0,10);
              }

              var valStr = impStr.replace("EUR", "").replace(/\./g, "").replace(",", ".").replace(/\s/g, "");
              var val = parseFloat(valStr);
              if (!val || isNaN(val)) continue;

              if (val < 0) {
                var importe = -val;
                gastos.push({
                  id: Date.now().toString() + Math.random().toString(16).slice(2),
                  fecha: iso,
                  mes: iso.slice(0,7),
                  categoria: "Banco",
                  desc: concepto,
                  importe: importe
                });
                imported++;
              }
            }
            saveJSON(LS_KEYS.GASTOS, gastos);
            renderAll();
            alert("Importados " + imported + " movimientos como gastos desde el CSV.");
          } catch (e) {
            console.error(e);
            alert("No se ha podido leer el CSV. Revisa que sea el archivo correcto.");
          }
        };
        reader.readAsText(file, "utf-8");
      });
    }

    (function init() {
      var todayMonth = new Date().toISOString().slice(0, 7);
      var todayDate = new Date().toISOString().slice(0, 10);
      if (monthSelector) monthSelector.value = todayMonth;
      if (gastoFechaInput) gastoFechaInput.value = todayDate;
      refreshCategorySuggestions();
      renderAll();
    })();
  </script>
</body>
</html>
