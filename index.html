<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Econom√≠a Familiar ¬∑ v0.6</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <style>
    :root {
      --bg: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --card-bg: #ffffff;
      --primary: #667eea;
      --primary-dark: #5568d3;
      --danger: #ef4444;
      --success: #10b981;
      --text: #1f2937;
      --muted: #6b7280;
      --border: #e5e7eb;
      --radius: 16px;
      --shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
      --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    * { 
      box-sizing: border-box; 
      font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }
    html, body {
      margin: 0;
      padding: 0;
      max-width: 100vw;
      overflow-x: hidden;
    }
    body { 
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      padding-top: 160px;
      padding-bottom: 80px;
    }
    .app { 
      max-width: 1000px; 
      margin: 0 auto; 
      padding: 0 1rem; 
    }
    
    header {
      position: fixed; 
      top: 0; 
      left: 0;
      right: 0;
      z-index: 50;
      background: rgba(255, 255, 255, 0.98);
      backdrop-filter: blur(20px);
      padding: 0.7rem 0;
      border-bottom: 1px solid var(--border);
      box-shadow: var(--shadow-sm);
    }
    .header-inner {
      max-width: 1000px;
      margin: 0 auto;
      padding: 0 1rem;
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }
    .title-row { 
      display: flex; 
      align-items: center; 
      justify-content: space-between; 
      gap: 1rem; 
      flex-wrap: wrap;
    }
    .title-main { 
      display: flex; 
      align-items: center; 
      gap: 0.75rem; 
    }
    .title-icon {
      width: 48px; 
      height: 48px; 
      border-radius: 16px; 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex; 
      align-items: center; 
      justify-content: center;
      font-size: 1.5rem; 
      color: white;
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }
    .title-text { 
      display: flex; 
      flex-direction: column; 
    }
    .title-text strong { 
      font-size: 1.25rem; 
      font-weight: 700;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .title-text span { 
      font-size: 0.8rem; 
      color: var(--muted); 
    }
    
    .month-nav-container {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      background: #f9fafb;
      padding: 0.5rem;
      border-radius: 12px;
      border: 1px solid var(--border);
      position: relative;
    }
    .month-nav-btn {
      width: 32px;
      height: 32px;
      border: none;
      background: white;
      border-radius: 8px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.1rem;
      transition: all 0.2s;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .month-nav-btn:hover {
      background: var(--primary);
      color: white;
      transform: scale(1.05);
    }
    .month-nav-btn:active {
      transform: scale(0.95);
    }
    .month-display {
      min-width: 140px;
      text-align: center;
      font-weight: 600;
      font-size: 0.95rem;
      color: var(--text);
      cursor: pointer;
      padding: 0.25rem 0.5rem;
      border-radius: 6px;
      transition: all 0.2s;
    }
    .month-display:hover {
      background: rgba(102, 126, 234, 0.1);
    }
    .month-picker-dropdown {
      position: absolute;
      top: 100%;
      right: 0;
      margin-top: 0.5rem;
      background: white;
      border: 2px solid var(--border);
      border-radius: 12px;
      box-shadow: var(--shadow);
      padding: 1rem;
      display: none;
      z-index: 100;
      min-width: 280px;
    }
    .month-picker-dropdown.active {
      display: block;
    }
    .month-picker-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }
    .month-picker-year {
      font-size: 1.1rem;
      font-weight: 700;
      color: var(--text);
    }
    .year-nav-btn {
      background: none;
      border: none;
      font-size: 1.2rem;
      cursor: pointer;
      padding: 0.25rem 0.5rem;
      border-radius: 6px;
      transition: all 0.2s;
    }
    .year-nav-btn:hover {
      background: #f3f4f6;
    }
    .months-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 0.5rem;
    }
    .month-btn {
      padding: 0.75rem;
      border: 2px solid var(--border);
      background: white;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.85rem;
      font-weight: 600;
      transition: all 0.2s;
    }
    .month-btn:hover {
      background: #f9fafb;
      border-color: var(--primary);
    }
    .month-btn.selected {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-color: var(--primary);
    }
    
    .chips-row { 
      display: flex;
      flex-wrap: nowrap;
      gap: 0.5rem;
    }
    .chip {
      flex: 1;
      padding: 0.55rem 0.8rem; 
      border-radius: 10px; 
      background: var(--card-bg);
      border: 2px solid var(--border);
      display: flex; 
      flex-direction: column;
      gap: 0.25rem;
      font-size: 0.8rem; 
      box-shadow: var(--shadow-sm);
      transition: all 0.2s;
    }
    .chip:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow);
    }
    .chip span {
      color: var(--muted);
      font-weight: 500;
    }
    .chip-subline { font-size: 0.7rem; color: var(--muted); margin-top: 0.1rem; }
    .chip strong { 
      font-size: 1.0rem; 
      font-weight: 700;
    }
    .chip.in { 
      background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
      border-color: #10b981;
    }
    .chip.in strong { color: #047857; }
    .chip.out { 
      background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
      border-color: #ef4444;
    }
    .chip.out strong { color: #dc2626; }
    .chip.balance-pos { 
      background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
      border-color: #3b82f6;
    }
    .chip.balance-pos strong { color: #1d4ed8; }
    .chip.balance-neg { 
      background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
      border-color: #f59e0b;
    }
    .chip.balance-neg strong { color: #d97706; }
    
    main { 
      margin-top: 1rem; 
    }
    .card {
      background: var(--card-bg); 
      border-radius: var(--radius); 
      padding: 1.5rem;
      box-shadow: var(--shadow); 
      border: 1px solid var(--border);
      margin-bottom: 1.5rem;
      transition: all 0.3s;
    }
    .card:hover {
      box-shadow: 0 15px 40px rgba(0, 0, 0, 0.2);
    }
    .card-header { 
      display: flex; 
      justify-content: space-between; 
      align-items: flex-start; 
      gap: 1rem; 
      margin-bottom: 1rem; 
    }
    .card-title { 
      font-size: 1.2rem; 
      font-weight: 700;
      color: var(--text);
    }
    .card-subtitle { 
      font-size: 0.85rem; 
      color: var(--muted); 
      margin-top: 0.25rem; 
      line-height: 1.4;
    }
    .card-tag {
      font-size: 0.75rem; 
      padding: 0.35rem 0.75rem; 
      border-radius: 999px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      font-weight: 600;
      white-space: nowrap;
      box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
    }
    .grid-2 { 
      display: grid; 
      grid-template-columns: 1fr; 
      gap: 1rem; 
    }
    @media (min-width: 768px) { 
      .grid-2 { 
        grid-template-columns: repeat(2, 1fr); 
      } 
    }
    .field-group { 
      display: flex; 
      flex-direction: column; 
      gap: 0.4rem; 
      margin-bottom: 0.75rem; 
    }
    .field-group label { 
      font-size: 0.85rem; 
      color: var(--text); 
      font-weight: 600;
    }
    .field-group input, 
    .field-group select, 
    .field-group textarea {
      padding: 0.75rem; 
      border-radius: 10px; 
      border: 2px solid var(--border);
      font-size: 0.95rem; 
      background: #f9fafb; 
      width: 100%;
      transition: all 0.2s;
    }
    .field-group input[type="date"] {
      font-family: inherit;
    }
    .field-group input:focus, 
    .field-group select:focus, 
    .field-group textarea:focus {
      outline: none; 
      border-color: var(--primary); 
      background: white;
      box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
    }
    .small-text { 
      font-size: 0.8rem; 
      color: var(--muted); 
      line-height: 1.5;
    }
    .btn {
      border: none; 
      border-radius: 12px; 
      padding: 0.75rem 1.25rem;
      font-size: 0.9rem; 
      cursor: pointer;
      display: inline-flex; 
      align-items: center; 
      justify-content: center;
      gap: 0.5rem;
      font-weight: 600;
      transition: all 0.2s;
      box-shadow: var(--shadow-sm);
    }
    .btn:active { 
      transform: scale(0.97); 
    }
    .btn-primary { 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #fff; 
    }
    .btn-primary:hover { 
      box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
      transform: translateY(-2px);
    }
    .btn-success {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
    }
    .btn-success:hover {
      box-shadow: 0 8px 20px rgba(16, 185, 129, 0.4);
      transform: translateY(-2px);
    }
    .btn-outline { 
      background: white; 
      color: var(--text); 
      border: 2px solid var(--border); 
    }
    .btn-outline:hover { 
      background: #f9fafb; 
      border-color: var(--primary);
    }
    .btn-danger {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      color: white;
    }
    .btn-danger:hover {
      box-shadow: 0 8px 20px rgba(239, 68, 68, 0.4);
      transform: translateY(-2px);
    }
    .btn-edit {
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      color: white;
      font-size: 0.8rem;
      padding: 0.35rem 0.65rem;
    }
    .btn-edit:hover {
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
    }
    .btn-danger-chip {
      background: transparent; 
      color: var(--danger);
      border: 2px solid rgba(239, 68, 68, 0.3);
      border-radius: 8px; 
      font-size: 0.8rem; 
      padding: 0.35rem 0.65rem;
      cursor: pointer; 
      display: inline-flex; 
      align-items: center; 
      gap: 0.25rem;
      transition: all 0.2s;
      font-weight: 600;
    }
    .btn-danger-chip:hover { 
      background: var(--danger);
      color: white;
      transform: scale(1.05);
    }
    
    .fixed-expense-table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      margin-top: 1rem;
    }
    .fixed-expense-table th {
      background: #f9fafb;
      padding: 0.75rem;
      text-align: left;
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--text);
      border-bottom: 2px solid var(--border);
    }
    .fixed-expense-table th:first-child {
      border-radius: 8px 0 0 0;
    }
    .fixed-expense-table th:last-child {
      border-radius: 0 8px 0 0;
    }
    .fixed-expense-table td {
      padding: 0.75rem;
      border-bottom: 1px solid var(--border);
      font-size: 0.9rem;
    }
    .fixed-expense-table tr:last-child td {
      border-bottom: none;
    }
    .fixed-expense-table tr:hover {
      background: #f9fafb;
    }
    
    .budget-card {
      background: white;
      border-radius: 16px;
      padding: 1.25rem;
      margin-bottom: 1rem;
      border: 2px solid var(--border);
      transition: all 0.3s;
      position: relative;
      overflow: hidden;
    }
    .budget-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
    }
    .budget-card:hover {
      border-color: var(--primary);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
      transform: translateY(-2px);
    }
    .budget-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }
    .budget-name {
      font-size: 1.1rem;
      font-weight: 700;
      color: var(--text);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .budget-amounts {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 0.75rem;
      margin-bottom: 1rem;
    }
    .budget-amount-item {
      background: #f9fafb;
      padding: 0.75rem;
      border-radius: 10px;
    }
    .budget-amount-label {
      font-size: 0.75rem;
      color: var(--muted);
      font-weight: 600;
      margin-bottom: 0.25rem;
    }
    .budget-amount-value {
      font-size: 1.1rem;
      font-weight: 700;
    }
    .budget-progress-bar {
      width: 100%;
      height: 8px;
      background: #e5e7eb;
      border-radius: 999px;
      overflow: hidden;
      margin-bottom: 0.5rem;
    }
    .budget-progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #10b981 0%, #059669 100%);
      transition: width 0.5s ease;
      border-radius: 999px;
    }
    .budget-progress-fill.over {
      background: linear-gradient(90deg, #ef4444 0%, #dc2626 100%);
    }
    .budget-status {
      font-size: 0.85rem;
      font-weight: 600;
      text-align: center;
    }
    .budget-status.good {
      color: #059669;
    }
    .budget-status.warning {
      color: #f59e0b;
    }
    .budget-status.over {
      color: #dc2626;
    }
    
    .pill-list { 
      display: flex; 
      flex-direction: column; 
      gap: 0.5rem; 
      margin-top: 1rem; 
      max-height: 400px; 
      overflow-y: auto; 
    }
    .pill-item {
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      gap: 1rem;
      padding: 1rem; 
      border-radius: 12px;
      background: #f9fafb; 
      border: 2px solid var(--border); 
      font-size: 0.9rem;
      transition: all 0.2s;
    }
    .pill-item:hover {
      background: white;
      border-color: var(--primary);
      transform: translateX(4px);
    }
    .pill-main { 
      display: flex; 
      flex-direction: column; 
      gap: 0.25rem; 
      flex: 1; 
    }
    .pill-line1 { 
      font-weight: 600;
      color: var(--text);
    }
    .pill-line2 { 
      font-size: 0.8rem; 
      color: var(--muted); 
    }
    .pill-actions {
      display: flex;
      gap: 0.5rem;
    }
    .expense-list { 
      max-height: 400px; 
      overflow-y: auto; 
      margin-top: 1rem; 
    }
    .expense-item {
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      gap: 1rem;
      padding: 1rem; 
      border-radius: 12px;
      background: #f9fafb; 
      border: 2px solid var(--border); 
      font-size: 0.9rem;
      margin-bottom: 0.5rem;
      transition: all 0.2s;
    }
    .expense-item:hover {
      background: white;
      border-color: var(--primary);
      transform: translateX(4px);
    }
    .expense-main { 
      display: flex; 
      flex-direction: column; 
      gap: 0.25rem; 
      flex: 1; 
    }
    .expense-line1 { 
      font-weight: 600;
      color: var(--text);
    }
    .expense-line2 { 
      font-size: 0.8rem; 
      color: var(--muted); 
    }
    .expense-actions {
      display: flex;
      gap: 0.5rem;
      flex-shrink: 0;
    }
    .amount-neg { 
      color: var(--danger); 
      font-weight: 700; 
    }
    .notes-box { 
      width: 100%; 
      min-height: 100px; 
      resize: vertical; 
    }

    .tabs-container { 
      margin-bottom: 1rem; 
    }
    .tab-section { 
      display: none; 
    }
    .tab-section.active { 
      display: block;
      animation: fadeIn 0.3s ease-in;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .bottom-nav {
      position: fixed; 
      bottom: 0; 
      left: 0; 
      right: 0; 
      z-index: 50;
      background: rgba(255, 255, 255, 0.98); 
      backdrop-filter: blur(20px);
      padding: 0.5rem 0.5rem calc(0.5rem + env(safe-area-inset-bottom, 0));
      border-top: 1px solid var(--border);
      box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.1);
    }
    .bottom-nav-inner { 
      max-width: 1000px; 
      margin: 0 auto; 
      display: flex; 
      justify-content: space-around; 
      gap: 0.25rem; 
    }
    .tab-btn {
      flex: 1; 
      border: none; 
      background: transparent; 
      color: var(--muted);
      padding: 0.5rem 0.25rem; 
      display: flex; 
      flex-direction: column;
      align-items: center; 
      gap: 0.25rem; 
      font-size: 0.75rem; 
      border-radius: 12px;
      cursor: pointer; 
      transition: all 0.2s;
      font-weight: 500;
    }
    .tab-btn-icon {
      width: 28px; 
      height: 28px; 
      border-radius: 10px; 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      font-size: 1.2rem;
      transition: all 0.2s;
    }
    .tab-btn span.label { 
      font-size: 0.7rem;
    }
    .tab-btn.active { 
      color: var(--primary);
    }
    .tab-btn.active .tab-btn-icon { 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
      transform: scale(1.1);
    }
    .warn-box {
      background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
      border-radius: 12px; 
      border: 2px solid #f59e0b;
      padding: 1rem; 
      font-size: 0.85rem; 
      color: #92400e; 
      margin-top: 1rem;
      line-height: 1.5;
    }
    
    .toast {
      position: fixed; 
      top: 200px; 
      left: 50%; 
      transform: translateX(-50%);
      background: rgba(17, 24, 39, 0.95); 
      color: white; 
      padding: 1rem 1.5rem;
      border-radius: 12px; 
      font-size: 0.9rem; 
      z-index: 100;
      opacity: 0; 
      pointer-events: none;
      transition: opacity 0.3s;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      font-weight: 500;
      max-width: 90%;
    }
    .toast.show { 
      opacity: 1; 
    }
    
    .empty-state {
      text-align: center; 
      padding: 3rem 1rem;
      color: var(--muted); 
      font-size: 0.95rem;
    }
    .empty-state-icon {
      font-size: 3rem;
      margin-bottom: 1rem;
      opacity: 0.5;
    }
    
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 999;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 1rem;
    }
    .modal-overlay.active {
      display: flex;
    }
    .modal {
      background: white;
      border-radius: 16px;
      padding: 1.5rem;
      max-width: 500px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
    }
    .modal-title {
      font-size: 1.3rem;
      font-weight: 700;
      color: var(--text);
    }
    .modal-close {
      background: #f3f4f6;
      border: none;
      width: 32px;
      height: 32px;
      border-radius: 8px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
      transition: all 0.2s;
    }
    .modal-close:hover {
      background: #e5e7eb;
    }
    .modal-footer {
      display: flex;
      gap: 0.75rem;
      margin-top: 1.5rem;
    }
    .modal-footer .btn {
      flex: 1;
    }
  </style>
</head>
<body>
  <div class="toast" id="toast"></div>
  
  <div class="modal-overlay" id="editModal">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title" id="modalTitle">Editar</div>
        <button class="modal-close" id="modalClose">‚úï</button>
      </div>
      <div id="modalContent"></div>
      <div class="modal-footer">
        <button class="btn btn-outline" id="modalCancel">Cancelar</button>
        <button class="btn btn-primary" id="modalSave">Guardar cambios</button>
      </div>
    </div>
  </div>
  
  <header>
    <div class="header-inner">
      <div class="title-row">
        <div class="title-main">
          <div class="title-icon">üí∞</div>
          <div class="title-text">
            <strong>Econom√≠a Familiar ¬∑ v0.6</strong>
            <span>Control total de gastos e ingresos</span>
          </div>
        </div>
        <div class="month-nav-container">
          <button class="month-nav-btn" id="btnPrevMonth">‚óÄ</button>
          <div class="month-display" id="monthDisplay">Enero 2024</div>
          <button class="month-nav-btn" id="btnNextMonth">‚ñ∂</button>
          <div class="month-picker-dropdown" id="monthPickerDropdown">
            <div class="month-picker-header">
              <button class="year-nav-btn" id="yearPrev">‚óÄ</button>
              <div class="month-picker-year" id="pickerYear">2024</div>
              <button class="year-nav-btn" id="yearNext">‚ñ∂</button>
            </div>
            <div class="months-grid" id="monthsGrid"></div>
          </div>
        </div>
      </div>
      <div class="chips-row">
        <div class="chip in">
          <span>üíµ Entradas</span>
          <strong id="chipIngresos">0 ‚Ç¨</strong>
        </div>
        <div class="chip out">
          <span>üí∏ Gastos</span>
          <strong id="chipGastos">0 ‚Ç¨</strong>
        </div>
        <div class="chip balance-pos" id="chipBalanceWrap">
          <span>üìä Balance</span>
          <strong id="chipBalance">0 ‚Ç¨</strong>
        <small id="chipHuchasTotal" class="chip-subline">Huchas: 0 ‚Ç¨</small>
        </div>
      </div>
    </div>
  </header>

  <div class="app">
    <main class="tabs-container">
      <!-- INGRESOS -->
      <section class="tab-section active" data-tab="ingresos">
        <section class="card">
          <div class="card-header">
            <div>
              <div class="card-title">üí∞ Ingresos base mensuales</div>
              <div class="card-subtitle">
                Define los ingresos fijos que entran cada mes en tu hogar.
              </div>
            </div>
            <div class="card-tag">Ingresos</div>
          </div>
          <div class="grid-2">
            <div>
              <div class="field-group">
                <label>Juan (‚Ç¨ / mes)</label>
                <input type="number" id="ingJuan" step="0.01" inputmode="decimal" min="0" placeholder="0.00" />
              </div>
              <div class="field-group">
                <label>Saray (‚Ç¨ / mes)</label>
                <input type="number" id="ingSaray" step="0.01" inputmode="decimal" min="0" placeholder="0.00" />
              </div>
            </div>
            <div>
              <div class="field-group">
                <label>Otros ingresos fijos (‚Ç¨ / mes)</label>
                <input type="number" id="ingOtros" step="0.01" inputmode="decimal" min="0" placeholder="0.00" />
              </div>
              <button class="btn btn-primary" id="btnSaveIngresos">üíæ Guardar ingresos base</button>
            </div>
          </div>
        </section>

        <section class="card">
          <div class="card-header">
            <div>
              <div class="card-title">üìä Resumen del mes</div>
              <div class="card-subtitle">
                Visi√≥n general de tu situaci√≥n financiera este mes.
              </div>
            </div>
            <div class="card-tag">Resumen</div>
          </div>
          <div class="grid-2">
            <div>
              <div class="field-group">
                <label>üíµ Ingresos totales</label>
                <div id="resIngMes" class="small-text" style="font-size: 1.1rem; font-weight: 600; color: #10b981;">0 ‚Ç¨</div>
              </div>
              <div class="field-group">
                <label>üè† Gastos fijos</label>
                <div id="resFijosMes" class="small-text" style="font-size: 1.1rem; font-weight: 600; color: #ef4444;">0 ‚Ç¨</div>
              </div>
            </div>
            <div>
              <div class="field-group">
                <label>üõí Gastos variables</label>
                <div id="resVarMes" class="small-text" style="font-size: 1.1rem; font-weight: 600; color: #f59e0b;">0 ‚Ç¨</div>
              </div>
              <div class="field-group">
                <label>üíé Balance final</label>
                <div id="resBalMes" class="small-text" style="font-size: 1.1rem; font-weight: 600; color: #3b82f6;">0 ‚Ç¨</div>
              </div>
            </div>
          </div>
        </section>
      </section>

      <!-- GASTOS FIJOS -->
      <section class="tab-section" data-tab="fijos">
        <section class="card">
          <div class="card-header">
            <div>
              <div class="card-title">üè† A√±adir gasto fijo</div>
              <div class="card-subtitle">
                Gastos recurrentes mensuales: alquiler, luz, internet, seguros, etc.
              </div>
            </div>
            <div class="card-tag">Fijos</div>
          </div>
          <div class="grid-2">
            <div>
              <div class="field-group">
                <label>Nombre del gasto</label>
                <input type="text" id="fijoNombre" placeholder="Ej: Alquiler, Luz, Internet..." />
              </div>
            </div>
            <div>
              <div class="field-group">
                <label>Importe mensual (‚Ç¨)</label>
                <input type="number" id="fijoImporte" step="0.01" inputmode="decimal" min="0" placeholder="0.00" />
              </div>
              <button class="btn btn-success" id="btnAddFijo">‚ûï A√±adir gasto fijo</button>
            </div>
          </div>
        </section>

        <section class="card">
          <div class="card-header">
            <div>
              <div class="card-title">üìã Listado de gastos fijos</div>
              <div class="card-subtitle">
                Total mensual: <strong id="totalFijosDisplay" style="color: #ef4444;">0 ‚Ç¨</strong>
              </div>
            </div>
            <div class="card-tag">Listado</div>
          </div>
          <div id="fijosTableContainer"></div>
        </section>
      </section>

      <!-- GASTOS -->
      <section class="tab-section" data-tab="gastos">
        <section class="card">
          <div class="card-header">
            <div>
              <div class="card-title">üõí Registrar gasto</div>
              <div class="card-subtitle">
                Apunta cada compra del d√≠a para llevar un control exacto.
              </div>
            </div>
            <div class="card-tag">Gastos</div>
          </div>
          <div class="grid-2">
            <div>
              <div class="field-group">
                <label>üìÖ Fecha</label>
                <input type="date" id="gastoFecha" />
              </div>
              <div class="field-group">
                <label>üè∑Ô∏è Categor√≠a</label>
                <input list="catSugerencias" id="gastoCategoria" placeholder="Alimentaci√≥n, Ocio, Huchas..." />
                <datalist id="catSugerencias"></datalist>
              </div>
            </div>
            <div>
              <div class="field-group">
                <label>üìù Descripci√≥n</label>
                <input type="text" id="gastoDesc" placeholder="Lidl, gasolina, cine..." />
              </div>
              <div class="field-group">
                <label>üí∞ Importe (‚Ç¨)</label>
                <input type="number" id="gastoImporte" step="0.01" inputmode="decimal" min="0.01" placeholder="0.00" />
              </div>
              <button class="btn btn-primary" id="btnAddGasto">‚ûï Guardar gasto</button>
            </div>
          </div>
        </section>

        <section class="card">
          <div class="card-header">
            <div>
              <div class="card-title">üìä Gastos del mes</div>
              <div class="card-subtitle">
                Todos los gastos registrados en el mes seleccionado.
              </div>
            </div>
            <div class="card-tag">Listado</div>
          </div>
          <div id="gastosLista" class="expense-list"></div>
        </section>
      </section>

      <!-- SOBRES -->
      <section class="tab-section" data-tab="sobres">
        <section class="card">
          <div class="card-header">
            <div>
              <div class="card-title">üì© Crear presupuesto</div>
              <div class="card-subtitle">
                Define cu√°nto quieres gastar en cada categor√≠a mensualmente.
              </div>
            </div>
            <div class="card-tag">Sobres</div>
          </div>
          <div class="grid-2">
            <div>
              <div class="field-group">

                <label>Nombre del sobre</label>
                <input type="text" id="sobreNombre" placeholder="Alimentaci√≥n, Ocio, Transporte..." />
              </div>
            </div>
            <div>
              <div class="field-group">
                <label>Presupuesto mensual (‚Ç¨)</label>
                <input type="number" id="sobreImporte" step="0.01" inputmode="decimal" min="0" placeholder="0.00" />
              </div>
              <button class="btn btn-success" id="btnAddSobre">üíæ Crear presupuesto</button>
            </div>
          </div>
        </section>

        <section class="card">
          <div class="card-header">
            <div>
              <div class="card-title">üìä Estado de presupuestos</div>
              <div class="card-subtitle">
                Cu√°nto has gastado vs cu√°nto ten√≠as presupuestado.
              </div>
            </div>
            <div class="card-tag">Estado</div>
          </div>
          <div id="sobresLista" class="pill-list"></div>
        </section>
      </section>

      <!-- HUCHAS -->
      <section class="tab-section" data-tab="huchas">
        <section class="card">
          <div class="card-header">
            <div>
              <div class="card-title">üê∑ Crear hucha de ahorro</div>
              <div class="card-subtitle">
                Guarda dinero para objetivos espec√≠ficos: viajes, compras grandes, emergencias...
              </div>
            </div>
            <div class="card-tag">Huchas</div>
          </div>
          <div class="grid-2">
            <div>
              <div class="field-group">
                <label>Nombre de la hucha</label>
                <input type="text" id="huchaNombre" placeholder="Black Friday, Viaje, PS5..." />
              </div>
              <div class="field-group">
                <label>Objetivo (‚Ç¨) - opcional</label>
                <input type="number" id="huchaObjetivo" step="0.01" inputmode="decimal" min="0" placeholder="0.00" />
              </div>
            </div>
            <div>
              <div class="field-group">
                <label>Saldo inicial (‚Ç¨) - opcional</label>
                <input type="number" id="huchaSaldoInicial" step="0.01" inputmode="decimal" min="0" placeholder="0.00" />
              </div>
              <button class="btn btn-success" id="btnAddHucha">‚ûï Crear hucha</button>
            </div>
          </div>
        </section>

        <section class="card">
          <div class="card-header">
            <div>
              <div class="card-title">üí∞ Movimientos en huchas</div>
              <div class="card-subtitle">
                Aportar crea un gasto en "Huchas". Retirar solo reduce el saldo guardado.
              </div>
            </div>
            <div class="card-tag">Movimientos</div>
          </div>
          <div class="grid-2">
            <div>
              <div class="field-group">
                <label>Seleccionar hucha</label>
                <select id="huchaSelect">
                  <option value="">-- Elige una hucha --</option>
                </select>
              </div>
              <div class="field-group">
                <label>Importe (‚Ç¨)</label>
                <input type="number" id="huchaImporte" step="0.01" inputmode="decimal" min="0.01" placeholder="0.00" />
              </div>
            </div>
            <div>
              <div class="field-group">
                <label>Acci√≥n</label>
                <select id="huchaAccion">
                  <option value="aportar">üíµ Aportar (ahorrar dinero)</option>
                  <option value="retirar">üí∏ Retirar (usar ahorros)</option>
                </select>
              </div>
              <button class="btn btn-primary" id="btnHuchaMovimiento">üí∞ Registrar movimiento</button>
            </div>
          </div>
          <div class="small-text" style="margin-top:0.75rem; padding: 0.75rem; background: #f0f9ff; border-radius: 8px; border-left: 3px solid #3b82f6;">
            <strong>üí° C√≥mo funciona:</strong><br />
            ¬∑ <strong>Aportar:</strong> Suma al saldo de la hucha y registra un gasto en la categor√≠a "Huchas".<br />
            ¬∑ <strong>Retirar:</strong> Resta del saldo de la hucha, sin crear ning√∫n gasto adicional.
          </div>
        </section>

        <section class="card">
          <div class="card-header">
            <div>
              <div class="card-title">üìã Mis huchas</div>
              <div class="card-subtitle">
                Saldo actual, objetivos y progreso de cada hucha.
              </div>
            </div>
            <div class="card-tag">Listado</div>
          </div>
          <div id="huchasLista" class="pill-list"></div>
        </section>
      </section>

      <!-- CONFIG -->
      <section class="tab-section" data-tab="config">
        <section class="card">
          <div class="card-header">
            <div>
              <div class="card-title">üì§ Exportar datos</div>
              <div class="card-subtitle">
                Descarga una copia de seguridad de todos tus datos en formato JSON.
              </div>
            </div>
            <div class="card-tag">Backup</div>
          </div>
          <button class="btn btn-primary" id="btnExportJson">üì• Descargar copia de seguridad</button>
          <div class="small-text" style="margin-top:0.75rem;">
            Guarda este archivo en un lugar seguro (iCloud, Google Drive, email...) para poder recuperar tus datos si cambias de dispositivo.
          </div>
        </section>

        <section class="card">
          <div class="card-header">
            <div>
              <div class="card-title">üì• Importar datos</div>
              <div class="card-subtitle">
                Restaura una copia de seguridad anterior.
              </div>
            </div>
            <div class="card-tag">Restaurar</div>
          </div>
          <div class="grid-2">
            <div>
              <div class="field-group">
                <label>Desde archivo JSON</label>
                <input type="file" id="importFile" accept="application/json,.json" />
              </div>
              <button class="btn btn-outline" id="btnImportJsonFile">üì§ Importar desde archivo</button>
            </div>
            <div>
              <div class="field-group">
                <label>O pegar JSON aqu√≠</label>
                <textarea id="importJsonText" class="notes-box" placeholder="Pega el contenido del JSON..."></textarea>
              </div>
              <button class="btn btn-primary" id="btnImportJsonText">üì§ Importar desde texto</button>
            </div>
          </div>
          <div class="warn-box">
            ‚ö†Ô∏è <strong>Atenci√≥n:</strong> Al importar se sobrescribir√°n todos los datos actuales (ingresos, gastos fijos, sobres, huchas, gastos y notas).
          </div>
        </section>

        <section class="card">
          <div class="card-header">
            <div>
              <div class="card-title">üìÑ Importar desde CSV bancario</div>
              <div class="card-subtitle">
                Importa movimientos desde el CSV de CaixaBank (Concepto;Fecha;Importe;Saldo).
              </div>
            </div>
            <div class="card-tag">CSV</div>
          </div>
          <div class="grid-2">
            <div>
              <div class="field-group">
                <label>Archivo CSV</label>
                <input type="file" id="csvFile" accept=".csv,text/csv" />
              </div>
            </div>
            <div>
              <button class="btn btn-primary" id="btnImportCsv">üì§ Importar movimientos</button>
              <div class="small-text" style="margin-top:0.5rem;">
                Solo se importan cargos (importes negativos). Cada cargo se a√±ade como gasto en la categor√≠a "Banco".
              </div>
            </div>
          </div>
        </section>

        <section class="card">
          <div class="card-header">
            <div>
              <div class="card-title">üìù Notas del mes</div>
              <div class="card-subtitle">
                A√±ade comentarios o recordatorios sobre el mes actual.
              </div>
            </div>
            <div class="card-tag">Notas</div>
          </div>
          <div class="field-group">
            <textarea id="notasMes" class="notes-box" placeholder="Ej: Este mes hubo gastos extra por..."></textarea>
          </div>
          <button class="btn btn-primary" id="btnSaveNotas">üíæ Guardar notas</button>
        </section>

        <section class="card">
          <div class="card-header">
            <div>
              <div class="card-title">üóëÔ∏è Borrar todos los datos</div>
              <div class="card-subtitle">
                Resetea la aplicaci√≥n al estado inicial. Esta acci√≥n no se puede deshacer.
              </div>
            </div>
            <div class="card-tag">Peligro</div>
          </div>
          <button class="btn btn-danger" id="btnResetAll">üß® Borrar todo y empezar de cero</button>
          <div class="small-text" style="margin-top:0.75rem; color: #dc2626;">
            ‚ö†Ô∏è Esta acci√≥n eliminar√° permanentemente todos los datos guardados en este dispositivo.
          </div>
        </section>
      </section>
    </main>
  </div>

  <nav class="bottom-nav">
    <div class="bottom-nav-inner">
      <button class="tab-btn active" data-tab-target="ingresos">
        <div class="tab-btn-icon">üíµ</div>
        <span class="label">Ingresos</span>
      </button>
      <button class="tab-btn" data-tab-target="fijos">
        <div class="tab-btn-icon">üè†</div>
        <span class="label">Fijos</span>
      </button>
      <button class="tab-btn" data-tab-target="gastos">
        <div class="tab-btn-icon">üõí</div>
        <span class="label">Gastos</span>
      </button>
      <button class="tab-btn" data-tab-target="sobres">
        <div class="tab-btn-icon">üì©</div>
        <span class="label">Sobres</span>
      </button>
      <button class="tab-btn" data-tab-target="huchas">
        <div class="tab-btn-icon">üê∑</div>
        <span class="label">Huchas</span>
      </button>
      <button class="tab-btn" data-tab-target="config">
        <div class="tab-btn-icon">‚öôÔ∏è</div>
        <span class="label">Config</span>
      </button>
    </div>
  </nav>

  <script>

    // Utilidades
    function formatCurrency(num) {
      var n = Number(num) || 0;
      return n.toLocaleString("es-ES", {
        style: "currency",
        currency: "EUR",
        minimumFractionDigits: 2
      });
    }

    function showToast(message) {
      var toast = document.getElementById("toast");
      toast.textContent = message;
      toast.classList.add("show");
      setTimeout(function() {
        toast.classList.remove("show");
      }, 3000);
    }

    function loadJSON(key, fallback) {
      try {
        var raw = localStorage.getItem(key);
        if (!raw) return fallback;
        return JSON.parse(raw);
      } catch (e) {
        console.error("loadJSON error", key, e);
        return fallback;
      }
    }

    function saveJSON(key, value) {
      try {
        localStorage.setItem(key, JSON.stringify(value));
      } catch (e) {
        console.error("saveJSON error", key, e);
      }
    }

    function formatMonthDisplay(yearMonth) {
      var months = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 
                    'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
      var parts = yearMonth.split('-');
      var year = parts[0];
      var monthIdx = parseInt(parts[1], 10) - 1;
      return months[monthIdx] + ' ' + year;
    }

    // Constantes
    var LS_KEYS = {
      BASE: "eco_base",
      SOBRES: "eco_sobres",
      HUCHAS: "eco_huchas",
      GASTOS: "eco_gastos",
      NOTAS: "eco_notas",
      FIJOS: "eco_fijos",
      INGRESOS_PUNTUALES: "eco_ingresos_puntuales",
      CURRENT_MONTH: "eco_current_month"
    };

    // Estado global
    var DEFAULT_BASE = { juan: 0, saray: 0, otros: 0 };
    var baseConfig = loadJSON(LS_KEYS.BASE, DEFAULT_BASE);
    var sobres = loadJSON(LS_KEYS.SOBRES, {});
    var huchas = loadJSON(LS_KEYS.HUCHAS, []);
    var gastos = loadJSON(LS_KEYS.GASTOS, []);
    var notasByMonth = loadJSON(LS_KEYS.NOTAS, {});
    var gastosFijos = loadJSON(LS_KEYS.FIJOS, []);
    var ingresosPuntuales = loadJSON(LS_KEYS.INGRESOS_PUNTUALES, []);
    var currentMonth = loadJSON(LS_KEYS.CURRENT_MONTH, new Date().toISOString().slice(0, 7));
    var editingItem = null;
    var editingType = null;

    // Referencias del DOM
    var monthDisplay = document.getElementById("monthDisplay");
    var btnPrevMonth = document.getElementById("btnPrevMonth");
    var btnNextMonth = document.getElementById("btnNextMonth");
    var monthPickerDropdown = document.getElementById("monthPickerDropdown");
    var pickerYear = document.getElementById("pickerYear");
    var yearPrev = document.getElementById("yearPrev");
    var yearNext = document.getElementById("yearNext");
    var monthsGrid = document.getElementById("monthsGrid");
    
    var chipIngresos = document.getElementById("chipIngresos");
    var chipGastos = document.getElementById("chipGastos");
    var chipBalance = document.getElementById("chipBalance");
    var chipBalanceWrap = document.getElementById("chipBalanceWrap");
    var chipHuchasTotal = document.getElementById("chipHuchasTotal");

    var ingJuanInput = document.getElementById("ingJuan");
    var ingSarayInput = document.getElementById("ingSaray");
    var ingOtrosInput = document.getElementById("ingOtros");
    var btnSaveIngresos = document.getElementById("btnSaveIngresos");

    var ingresoPuntualFechaInput = document.getElementById("ingresoPuntualFecha");
    var ingresoPuntualDescInput = document.getElementById("ingresoPuntualDesc");
    var ingresoPuntualImporteInput = document.getElementById("ingresoPuntualImporte");
    var btnAddIngresoPuntual = document.getElementById("btnAddIngresoPuntual");
    var ingresosPuntualesListaDiv = document.getElementById("ingresosPuntualesLista");

    var resIngMesDiv = document.getElementById("resIngMes");
    var resFijosMesDiv = document.getElementById("resFijosMes");
    var resVarMesDiv = document.getElementById("resVarMes");
    var resBalMesDiv = document.getElementById("resBalMes");

    var fijoNombreInput = document.getElementById("fijoNombre");
    var fijoImporteInput = document.getElementById("fijoImporte");
    var btnAddFijo = document.getElementById("btnAddFijo");
    var fijosTableContainer = document.getElementById("fijosTableContainer");
    var totalFijosDisplay = document.getElementById("totalFijosDisplay");

    var gastoFechaInput = document.getElementById("gastoFecha");
    var gastoCategoriaInput = document.getElementById("gastoCategoria");
    var gastoDescInput = document.getElementById("gastoDesc");
    var gastoImporteInput = document.getElementById("gastoImporte");
    var btnAddGasto = document.getElementById("btnAddGasto");
    var gastosListaDiv = document.getElementById("gastosLista");
    var catSugerencias = document.getElementById("catSugerencias");

    var sobreNombreInput = document.getElementById("sobreNombre");
    var sobreImporteInput = document.getElementById("sobreImporte");
    var btnAddSobre = document.getElementById("btnAddSobre");
    var sobresListaDiv = document.getElementById("sobresLista");

    var huchaNombreInput = document.getElementById("huchaNombre");
    var huchaObjetivoInput = document.getElementById("huchaObjetivo");
    var huchaSaldoInicialInput = document.getElementById("huchaSaldoInicial");
    var btnAddHucha = document.getElementById("btnAddHucha");
    var huchaSelect = document.getElementById("huchaSelect");
    var huchaImporteInput = document.getElementById("huchaImporte");
    var huchaAccionSelect = document.getElementById("huchaAccion");
    var btnHuchaMovimiento = document.getElementById("btnHuchaMovimiento");
    var huchasListaDiv = document.getElementById("huchasLista");

    var notasMesTextarea = document.getElementById("notasMes");
    var btnSaveNotas = document.getElementById("btnSaveNotas");

    var btnExportJson = document.getElementById("btnExportJson");
    var importFileInput = document.getElementById("importFile");
    var btnImportJsonFile = document.getElementById("btnImportJsonFile");
    var importJsonTextArea = document.getElementById("importJsonText");
    var btnImportJsonText = document.getElementById("btnImportJsonText");
    var btnResetAll = document.getElementById("btnResetAll");

    var csvFileInput = document.getElementById("csvFile");
    var btnImportCsv = document.getElementById("btnImportCsv");

    var editModal = document.getElementById("editModal");
    var modalTitle = document.getElementById("modalTitle");
    var modalContent = document.getElementById("modalContent");
    var modalClose = document.getElementById("modalClose");
    var modalCancel = document.getElementById("modalCancel");
    var modalSave = document.getElementById("modalSave");

    // Funciones auxiliares
    function currentMonthKey() {
      return currentMonth;
    }

    function gastosDelMes(mes) {
      var out = [];
      for (var i = 0; i < gastos.length; i++) {
        if (gastos[i].mes === mes) out.push(gastos[i]);
      }
      return out;
    }

    function ingresosPuntualesDelMes(mes) {
      var out = [];
      for (var i = 0; i < ingresosPuntuales.length; i++) {

        if (ingresosPuntuales[i].mes === mes) out.push(ingresosPuntuales[i]);
      }
      return out;
    }

    function calcularTotalFijos() {
      var total = 0;
      for (var i = 0; i < gastosFijos.length; i++) {
        total += gastosFijos[i].importe || 0;
      }
      return total;
    }

    function calcularIngresosPuntualesMes(mes) {
      var lista = ingresosPuntualesDelMes(mes);
      var total = 0;
      for (var i = 0; i < lista.length; i++) {
        total += lista[i].importe || 0;
      }
      return total;
    }

    function refreshCategorySuggestions() {
      if (!catSugerencias) return;
      while (catSugerencias.firstChild) catSugerencias.removeChild(catSugerencias.firstChild);
      var set = {};
      for (var cat in sobres) { if (sobres.hasOwnProperty(cat)) set[cat] = true; }
      set["Huchas"] = true;
      for (var i = 0; i < huchas.length; i++) { set[huchas[i].nombre] = true; }
      for (var name in set) {
        if (!set.hasOwnProperty(name)) continue;
        var opt = document.createElement("option");
        opt.value = name;
        catSugerencias.appendChild(opt);
      }
    }

    // Modal functions
    function openEditModal(type, item) {
      editingItem = item;
      editingType = type;
      modalContent.innerHTML = '';
      
      if (type === 'gasto') {
        modalTitle.textContent = '‚úèÔ∏è Editar Gasto';
        modalContent.innerHTML = `
          <div class="field-group">
            <label>üìÖ Fecha</label>
            <input type="date" id="editFecha" value="${item.fecha}" />
          </div>
          <div class="field-group">
            <label>üè∑Ô∏è Categor√≠a</label>
            <input type="text" id="editCategoria" value="${item.categoria || ''}" />
          </div>
          <div class="field-group">
            <label>üìù Descripci√≥n</label>
            <input type="text" id="editDesc" value="${item.desc || ''}" />
          </div>
          <div class="field-group">
            <label>üí∞ Importe (‚Ç¨)</label>
            <input type="number" id="editImporte" step="0.01" value="${item.importe}" />
          </div>
        `;
      } else if (type === 'ingresoPuntual') {
        modalTitle.textContent = '‚úèÔ∏è Editar Ingreso Puntual';
        modalContent.innerHTML = `
          <div class="field-group">
            <label>üìÖ Fecha</label>
            <input type="date" id="editFecha" value="${item.fecha}" />
          </div>
          <div class="field-group">
            <label>üìù Descripci√≥n</label>
            <input type="text" id="editDesc" value="${item.desc || ''}" />
          </div>
          <div class="field-group">
            <label>üí∞ Importe (‚Ç¨)</label>
            <input type="number" id="editImporte" step="0.01" value="${item.importe}" />
          </div>
        `;
      } else if (type === 'fijo') {
        modalTitle.textContent = '‚úèÔ∏è Editar Gasto Fijo';
        modalContent.innerHTML = `
          <div class="field-group">
            <label>Nombre del gasto</label>
            <input type="text" id="editNombre" value="${item.nombre}" />
          </div>
          <div class="field-group">
            <label>üí∞ Importe mensual (‚Ç¨)</label>
            <input type="number" id="editImporte" step="0.01" value="${item.importe}" />
          </div>
        `;
      } else if (type === 'sobre') {
        modalTitle.textContent = '‚úèÔ∏è Editar Presupuesto';
        modalContent.innerHTML = `
          <div class="field-group">
            <label>Nombre del presupuesto</label>
            <input type="text" id="editNombre" value="${item.nombre}" />
          </div>
          <div class="field-group">
            <label>üí∞ Presupuesto mensual (‚Ç¨)</label>
            <input type="number" id="editImporte" step="0.01" value="${item.importe}" />
          </div>
        `;
      } else if (type === 'hucha') {
        modalTitle.textContent = '‚úèÔ∏è Editar Hucha';
        modalContent.innerHTML = `
          <div class="field-group">
            <label>Nombre de la hucha</label>
            <input type="text" id="editNombre" value="${item.nombre}" />
          </div>
          <div class="field-group">
            <label>üéØ Objetivo (‚Ç¨)</label>
            <input type="number" id="editObjetivo" step="0.01" value="${item.objetivo || 0}" />
          </div>
          <div class="field-group">
            <label>üí∞ Saldo actual (‚Ç¨)</label>
            <input type="number" id="editSaldo" step="0.01" value="${item.saldo || 0}" />
          </div>
        `;
      }
      
      editModal.classList.add('active');
    }

    function closeEditModal() {
      editModal.classList.remove('active');
      editingItem = null;
      editingType = null;
    }

    function saveEdit() {
      if (!editingItem || !editingType) return;
      
      if (editingType === 'gasto') {
        var fecha = document.getElementById('editFecha').value;
        editingItem.fecha = fecha;
        editingItem.mes = fecha.slice(0, 7);
        editingItem.categoria = document.getElementById('editCategoria').value.trim() || 'Otros';
        editingItem.desc = document.getElementById('editDesc').value.trim();
        editingItem.importe = parseFloat(document.getElementById('editImporte').value) || 0;
        saveJSON(LS_KEYS.GASTOS, gastos);
        showToast('‚úÖ Gasto actualizado');
      } else if (editingType === 'ingresoPuntual') {
        var fecha = document.getElementById('editFecha').value;
        editingItem.fecha = fecha;
        editingItem.mes = fecha.slice(0, 7);
        editingItem.desc = document.getElementById('editDesc').value.trim();
        editingItem.importe = parseFloat(document.getElementById('editImporte').value) || 0;
        saveJSON(LS_KEYS.INGRESOS_PUNTUALES, ingresosPuntuales);
        showToast('‚úÖ Ingreso actualizado');
      } else if (editingType === 'fijo') {
        editingItem.nombre = document.getElementById('editNombre').value.trim();
        editingItem.importe = parseFloat(document.getElementById('editImporte').value) || 0;
        saveJSON(LS_KEYS.FIJOS, gastosFijos);
        showToast('‚úÖ Gasto fijo actualizado');
      } else if (editingType === 'sobre') {
        var nuevoNombre = document.getElementById('editNombre').value.trim();
        var nuevoImporte = parseFloat(document.getElementById('editImporte').value) || 0;
        if (nuevoNombre !== editingItem.nombre) {
          delete sobres[editingItem.nombre];
        }
        sobres[nuevoNombre] = nuevoImporte;
        saveJSON(LS_KEYS.SOBRES, sobres);
        showToast('‚úÖ Presupuesto actualizado');
      } else if (editingType === 'hucha') {
        editingItem.nombre = document.getElementById('editNombre').value.trim();
        editingItem.objetivo = parseFloat(document.getElementById('editObjetivo').value) || 0;
        editingItem.saldo = parseFloat(document.getElementById('editSaldo').value) || 0;
        saveJSON(LS_KEYS.HUCHAS, huchas);
        showToast('‚úÖ Hucha actualizada');
      }
      
      closeEditModal();
      renderAll();
    }

    modalClose.addEventListener('click', closeEditModal);
    modalCancel.addEventListener('click', closeEditModal);
    modalSave.addEventListener('click', saveEdit);
    
    editModal.addEventListener('click', function(e) {
      if (e.target === editModal) closeEditModal();
    });

    // Month picker functions
    function renderMonthPicker() {
      var months = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
      var year = parseInt(pickerYear.textContent);
      var currentParts = currentMonth.split('-');
      var currentYear = parseInt(currentParts[0]);
      var currentMonthNum = parseInt(currentParts[1]);
      
      monthsGrid.innerHTML = '';
      for (var i = 0; i < 12; i++) {
        var btn = document.createElement('button');
        btn.className = 'month-btn';
        btn.textContent = months[i];
        btn.setAttribute('data-month', i + 1);
        
        if (year === currentYear && (i + 1) === currentMonthNum) {
          btn.classList.add('selected');
        }
        
        btn.addEventListener('click', function() {
          var month = this.getAttribute('data-month');
          if (month.length === 1) month = '0' + month;
          currentMonth = year + '-' + month;
          saveJSON(LS_KEYS.CURRENT_MONTH, currentMonth);
          monthPickerDropdown.classList.remove('active');
          renderAll();
        });
        
        monthsGrid.appendChild(btn);
      }
    }

    monthDisplay.addEventListener('click', function() {
      var parts = currentMonth.split('-');
      pickerYear.textContent = parts[0];
      renderMonthPicker();
      monthPickerDropdown.classList.toggle('active');
    });

    yearPrev.addEventListener('click', function() {
      var year = parseInt(pickerYear.textContent);
      pickerYear.textContent = year - 1;
      renderMonthPicker();
    });

    yearNext.addEventListener('click', function() {
      var year = parseInt(pickerYear.textContent);
      pickerYear.textContent = year + 1;
      renderMonthPicker();
    });

    document.addEventListener('click', function(e) {
      if (!monthDisplay.contains(e.target) && !monthPickerDropdown.contains(e.target)) {
        monthPickerDropdown.classList.remove('active');
      }
    });

    // Funciones de renderizado
    function renderMonthDisplay() {
      monthDisplay.textContent = formatMonthDisplay(currentMonth);
    }

    function renderIngresosForm() {
      ingJuanInput.value = baseConfig.juan || "";
      ingSarayInput.value = baseConfig.saray || "";
      ingOtrosInput.value = baseConfig.otros || "";
    }

    function renderIngresosPuntuales(mes) {
      if (!ingresosPuntualesListaDiv) return;
      while (ingresosPuntualesListaDiv.firstChild) {
        ingresosPuntualesListaDiv.removeChild(ingresosPuntualesListaDiv.firstChild);
      }
      var lista = ingresosPuntualesDelMes(mes);
      if (!lista.length) {
        var empty = document.createElement("div");
        empty.className = "empty-state";
        empty.innerHTML = '<div class="empty-state-icon">üíµ</div>No hay ingresos puntuales en este mes.';
        ingresosPuntualesListaDiv.appendChild(empty);
        return;
      }
      lista.sort(function(a, b){ return b.fecha.localeCompare(a.fecha); });
      for (var i = 0; i < lista.length; i++) {
        var ing = lista[i];
        var item = document.createElement("div");
        item.className = "expense-item";

        var main = document.createElement("div");
        main.className = "expense-main";

        var l1 = document.createElement("div");
        l1.className = "expense-line1";
        l1.style.color = "#10b981";
        l1.textContent = "Ingreso ¬∑ ";
        var spanAmt = document.createElement("span");
        spanAmt.style.color = "#10b981";
        spanAmt.style.fontWeight = "700";
        spanAmt.textContent = formatCurrency(ing.importe);
        l1.appendChild(spanAmt);

        var l2 = document.createElement("div");
        l2.className = "expense-line2";
        l2.textContent = ing.fecha + " ¬∑ " + (ing.desc || "Sin descripci√≥n");

        main.appendChild(l1);
        main.appendChild(l2);

        var actions = document.createElement("div");
        actions.className = "expense-actions";

        var btnEdit = document.createElement("button");
        btnEdit.className = "btn-edit";
        btnEdit.textContent = "‚úèÔ∏è";
        btnEdit.onclick = function(ingreso) {
          return function() { openEditModal('ingresoPuntual', ingreso); };
        }(ing);

        var btnDel = document.createElement("button");
        btnDel.className = "btn-danger-chip";
        btnDel.textContent = "‚úï";
        btnDel.setAttribute("data-type", "ingresoPuntual");
        btnDel.setAttribute("data-id", ing.id);

        actions.appendChild(btnEdit);
        actions.appendChild(btnDel);

        item.appendChild(main);
        item.appendChild(actions);
        ingresosPuntualesListaDiv.appendChild(item);
      }
    }

    function renderFijos() {
      var total = calcularTotalFijos();
      totalFijosDisplay.textContent = formatCurrency(total);
      
      while (fijosTableContainer.firstChild) {
        fijosTableContainer.removeChild(fijosTableContainer.firstChild);
      }

      if (!gastosFijos.length) {
        var empty = document.createElement("div");
        empty.className = "empty-state";
        empty.innerHTML = '<div class="empty-state-icon">üè†</div>No hay gastos fijos registrados todav√≠a.<br/>A√±ade tu primer gasto fijo arriba.';
        fijosTableContainer.appendChild(empty);
        return;
      }

      var table = document.createElement("table");
      table.className = "fixed-expense-table";

      var thead = document.createElement("thead");
      var headerRow = document.createElement("tr");
      var th1 = document.createElement("th");
      th1.textContent = "Concepto";
      var th2 = document.createElement("th");
      th2.textContent = "Importe";
      th2.style.textAlign = "right";
      var th3 = document.createElement("th");
      th3.textContent = "Acciones";
      th3.style.textAlign = "center";
      th3.style.width = "150px";
      headerRow.appendChild(th1);
      headerRow.appendChild(th2);
      headerRow.appendChild(th3);
      thead.appendChild(headerRow);
      table.appendChild(thead);

      var tbody = document.createElement("tbody");
      for (var i = 0; i < gastosFijos.length; i++) {
        var fijo = gastosFijos[i];
        var row = document.createElement("tr");

        var td1 = document.createElement("td");
        td1.textContent = fijo.nombre;

        var td2 = document.createElement("td");
        td2.textContent = formatCurrency(fijo.importe);
        td2.style.textAlign = "right";
        td2.style.fontWeight = "600";

        var td3 = document.createElement("td");
        td3.style.textAlign = "center";
        td3.style.display = "flex";
        td3.style.gap = "0.5rem";
        td3.style.justifyContent = "center";
        
        var btnEdit = document.createElement("button");
        btnEdit.className = "btn-edit";
        btnEdit.textContent = "‚úèÔ∏è";
        btnEdit.onclick = function(f) {
          return function() { openEditModal('fijo', f); };
        }(fijo);
        
        var btnDel = document.createElement("button");
        btnDel.className = "btn-danger-chip";
        btnDel.textContent = "‚úï";
        btnDel.setAttribute("data-type", "fijo");
        btnDel.setAttribute("data-id", fijo.id);
        
        td3.appendChild(btnEdit);
        td3.appendChild(btnDel);

        row.appendChild(td1);
        row.appendChild(td2);
        row.appendChild(td3);
        tbody.appendChild(row);
      }
      table.appendChild(tbody);
      fijosTableContainer.appendChild(table);
    }

    function renderResumen(mes) {
      var ingresosMes = (baseConfig.juan || 0) + (baseConfig.saray || 0) + (baseConfig.otros || 0);
      var ingresosPuntualesMes = calcularIngresosPuntualesMes(mes);
      var totalIngresos = ingresosMes + ingresosPuntualesMes;
      
      var lista = gastosDelMes(mes);
      var totalVar = 0;
      for (var i = 0; i < lista.length; i++) totalVar += lista[i].importe || 0;
      var totalFijos = calcularTotalFijos();
      var balance = totalIngresos - totalFijos - totalVar;

      // total ahorro acumulado en todas las huchas
      var totalHuchas = 0;
      for (var j = 0; j < huchas.length; j++) {
        totalHuchas += huchas[j].saldo || 0;
      }
      if (chipHuchasTotal) {
        chipHuchasTotal.textContent = "Huchas: " + formatCurrency(totalHuchas);
      }

      chipIngresos.textContent = formatCurrency(totalIngresos);
      chipGastos.textContent = formatCurrency(totalFijos + totalVar);
      chipBalance.textContent = formatCurrency(balance);
      if (balance >= 0) {
        chipBalanceWrap.classList.remove("balance-neg");
        chipBalanceWrap.classList.add("balance-pos");
      } else {
        chipBalanceWrap.classList.remove("balance-pos");
        chipBalanceWrap.classList.add("balance-neg");
      }

      resIngMesDiv.textContent = formatCurrency(totalIngresos);
      resFijosMesDiv.textContent = formatCurrency(totalFijos);
      resVarMesDiv.textContent = formatCurrency(totalVar);
      resBalMesDiv.textContent = formatCurrency(balance);
    }

    function renderGastos(mes) {
      while (gastosListaDiv.firstChild) gastosListaDiv.removeChild(gastosListaDiv.firstChild);
      var lista = gastosDelMes(mes);
      if (!lista.length) {
        var empty = document.createElement("div");
        empty.className = "empty-state";
        empty.innerHTML = '<div class="empty-state-icon">üõí</div>No hay gastos registrados en este mes.';
        gastosListaDiv.appendChild(empty);
        return;
      }
      lista.sort(function(a, b){ return b.fecha.localeCompare(a.fecha); });
      for (var i = 0; i < lista.length; i++) {
        var g = lista[i];
        var item = document.createElement("div");
        item.className = "expense-item";

        var main = document.createElement("div");
        main.className = "expense-main";

        var l1 = document.createElement("div");
        l1.className = "expense-line1";
        l1.textContent = g.categoria + " ¬∑ ";
        var spanAmt = document.createElement("span");
        spanAmt.className = "amount-neg";
        spanAmt.textContent = formatCurrency(g.importe);
        l1.appendChild(spanAmt);

        var l2 = document.createElement("div");
        l2.className = "expense-line2";
        l2.textContent = g.fecha + " ¬∑ " + (g.desc || "Sin descripci√≥n");

        main.appendChild(l1);
        main.appendChild(l2);

        var actions = document.createElement("div");
        actions.className = "expense-actions";

        var btnEdit = document.createElement("button");
        btnEdit.className = "btn-edit";
        btnEdit.textContent = "‚úèÔ∏è";
        btnEdit.onclick = function(gasto) {
          return function() { openEditModal('gasto', gasto); };
        }(g);

        var btnDel = document.createElement("button");
        btnDel.className = "btn-danger-chip";
        btnDel.textContent = "‚úï";
        btnDel.setAttribute("data-type", "gasto");
        btnDel.setAttribute("data-id", g.id);

        actions.appendChild(btnEdit);
        actions.appendChild(btnDel);

        item.appendChild(main);
        item.appendChild(actions);
        gastosListaDiv.appendChild(item);
      }
    }

    function renderSobres(mes) {
      while (sobresListaDiv.firstChild) sobresListaDiv.removeChild(sobresListaDiv.firstChild);
      var lista = gastosDelMes(mes);
      var porCat = {};
      for (var i = 0; i < lista.length; i++) {
        var g = lista[i];
        var cat = g.categoria || "Otros";
        if (!porCat[cat]) porCat[cat] = 0;
        porCat[cat] += g.importe || 0;
      }
      var cats = Object.keys(sobres);
      if (!cats.length) {
        var empty = document.createElement("div");
        empty.className = "empty-state";
        empty.innerHTML = '<div class="empty-state-icon">üì©</div>Crea tus primeros presupuestos mensuales.';
        sobresListaDiv.appendChild(empty);
        return;
      }
      for (var c = 0; c < cats.length; c++) {
        var catName = cats[c];
        var presup = sobres[catName] || 0;
        var gast = porCat[catName] || 0;
        var restante = presup - gast;
        var percentage = presup > 0 ? Math.min(100, (gast / presup) * 100) : 0;

        var card = document.createElement("div");
        card.className = "budget-card";

        var header = document.createElement("div");
        header.className = "budget-card-header";

        var name = document.createElement("div");
        name.className = "budget-name";
        name.textContent = catName;

        var actions = document.createElement("div");
        actions.className = "pill-actions";

        var btnEdit = document.createElement("button");
        btnEdit.className = "btn-edit";
        btnEdit.textContent = "‚úèÔ∏è";
        btnEdit.onclick = function(n, p) {
          return function() { openEditModal('sobre', {nombre: n, importe: p}); };
        }(catName, presup);

        var btnDel = document.createElement("button");
        btnDel.className = "btn-danger-chip";
        btnDel.textContent = "‚úï";
        btnDel.setAttribute("data-type", "sobre");
        btnDel.setAttribute("data-id", catName);

        actions.appendChild(btnEdit);
        actions.appendChild(btnDel);

        header.appendChild(name);
        header.appendChild(actions);

        var amounts = document.createElement("div");
        amounts.className = "budget-amounts";

        var presupItem = document.createElement("div");
        presupItem.className = "budget-amount-item";
        var presupLabel = document.createElement("div");
        presupLabel.className = "budget-amount-label";
        presupLabel.textContent = "Presupuesto";
        var presupValue = document.createElement("div");
        presupValue.className = "budget-amount-value";
        presupValue.style.color = "#3b82f6";
        presupValue.textContent = formatCurrency(presup);
        presupItem.appendChild(presupLabel);
        presupItem.appendChild(presupValue);

        var gastItem = document.createElement("div");
        gastItem.className = "budget-amount-item";
        var gastLabel = document.createElement("div");
        gastLabel.className = "budget-amount-label";
        gastLabel.textContent = "Gastado";
        var gastValue = document.createElement("div");
        gastValue.className = "budget-amount-value";
        gastValue.style.color = percentage > 100 ? "#ef4444" : "#f59e0b";
        gastValue.textContent = formatCurrency(gast);
        gastItem.appendChild(gastLabel);
        gastItem.appendChild(gastValue);

        amounts.appendChild(presupItem);
        amounts.appendChild(gastItem);

        var progressBar = document.createElement("div");
        progressBar.className = "budget-progress-bar";
        var progressFill = document.createElement("div");
        progressFill.className = "budget-progress-fill";
        if (percentage > 100) progressFill.classList.add("over");
        progressFill.style.width = Math.min(100, percentage) + "%";
        progressBar.appendChild(progressFill);

        var status = document.createElement("div");
        status.className = "budget-status";
        if (presup === 0 && gast === 0) {
          status.textContent = "Sin presupuesto definido";
          status.className += " warning";
        } else if (restante >= 0) {
          status.textContent = "‚úÖ Quedan " + formatCurrency(restante);
          status.className += " good";
        } else {
          status.textContent = "‚ö†Ô∏è Te pasas " + formatCurrency(-restante);
          status.className += " over";
        }

        card.appendChild(header);
        card.appendChild(amounts);
        card.appendChild(progressBar);
        card.appendChild(status);

        sobresListaDiv.appendChild(card);
      }
    }

    function renderHuchas() {
      while (huchasListaDiv.firstChild) huchasListaDiv.removeChild(huchasListaDiv.firstChild);
      while (huchaSelect.firstChild) huchaSelect.removeChild(huchaSelect.firstChild);
      var opt0 = document.createElement("option");
      opt0.value = "";
      opt0.textContent = "-- Elige una hucha --";
      huchaSelect.appendChild(opt0);

      if (!huchas.length) {
        var empty = document.createElement("div");
        empty.className = "empty-state";
        empty.innerHTML = '<div class="empty-state-icon">üê∑</div>Crea tu primera hucha de ahorro.';
        huchasListaDiv.appendChild(empty);
        refreshCategorySuggestions();
        return;
      }

      for (var i = 0; i < huchas.length; i++) {
        var h = huchas[i];
        var objetivo = h.objetivo || 0;
        var saldo = h.saldo || 0;
        var detalle = "üí∞ Saldo: " + formatCurrency(saldo);
        if (objetivo > 0) {
          var pct = Math.min(100, Math.round((saldo / objetivo) * 100));
          detalle += " ¬∑ üéØ Objetivo: " + formatCurrency(objetivo) + " (" + pct + "%)";
        }

        var item = document.createElement("div");
        item.className = "pill-item";

        var main = document.createElement("div");
        main.className = "pill-main";

        var l1 = document.createElement("div");
        l1.className = "pill-line1";
        l1.textContent = h.nombre;

        var l2 = document.createElement("div");
        l2.className = "pill-line2";
        l2.textContent = detalle;

        main.appendChild(l1);
        main.appendChild(l2);

        var actions = document.createElement("div");
        actions.className = "pill-actions";

        var btnEdit = document.createElement("button");
        btnEdit.className = "btn-edit";
        btnEdit.textContent = "‚úèÔ∏è";
        btnEdit.onclick = function(hucha) {
          return function() { openEditModal('hucha', hucha); };
        }(h);

        var btnDel = document.createElement("button");
        btnDel.className = "btn-danger-chip";
        btnDel.textContent = "‚úï";
        btnDel.setAttribute("data-type", "hucha");
        btnDel.setAttribute("data-id", h.id);

        actions.appendChild(btnEdit);
        actions.appendChild(btnDel);

        item.appendChild(main);
        item.appendChild(actions);
        huchasListaDiv.appendChild(item);

        var opt = document.createElement("option");
        opt.value = h.id;
        opt.textContent = h.nombre;
        huchaSelect.appendChild(opt);
      }
      refreshCategorySuggestions();
    }

    function renderNotas(mes) {
      notasMesTextarea.value = notasByMonth[mes] || "";
    }

    function renderAll() {
      var mes = currentMonthKey();
      renderMonthDisplay();
      renderIngresosForm();
      renderIngresosPuntuales(mes);
      renderFijos();
      renderResumen(mes);
      renderGastos(mes);
      renderSobres(mes);
      renderHuchas();
      renderNotas(mes);
    }

    // Navegaci√≥n de meses
    if (btnPrevMonth) {
      btnPrevMonth.addEventListener("click", function() {
        var parts = currentMonth.split('-');
        var year = parseInt(parts[0]);
        var month = parseInt(parts[1]);
        month--;
        if (month < 1) {
          month = 12;
          year--;
        }
        currentMonth = year + '-' + (month < 10 ? '0' + month : month);
        saveJSON(LS_KEYS.CURRENT_MONTH, currentMonth);
        renderAll();
      });
    }

    if (btnNextMonth) {
      btnNextMonth.addEventListener("click", function() {
        var parts = currentMonth.split('-');
        var year = parseInt(parts[0]);
        var month = parseInt(parts[1]);
        month++;
        if (month > 12) {
          month = 1;
          year++;
        }
        currentMonth = year + '-' + (month < 10 ? '0' + month : month);
        saveJSON(LS_KEYS.CURRENT_MONTH, currentMonth);
        renderAll();
      });
    }

    // Event listeners
    if (btnSaveIngresos) {
      btnSaveIngresos.addEventListener("click", function () {
        baseConfig.juan = parseFloat(ingJuanInput.value) || 0;
        baseConfig.saray = parseFloat(ingSarayInput.value) || 0;
        baseConfig.otros = parseFloat(ingOtrosInput.value) || 0;
        saveJSON(LS_KEYS.BASE, baseConfig);
                showToast("‚úÖ Ingresos guardados correctamente");
        renderAll();
      });
    }

    if (btnAddIngresoPuntual) {
      btnAddIngresoPuntual.addEventListener("click", function() {
        var fecha = ingresoPuntualFechaInput.value || new Date().toISOString().slice(0, 10);
        var mes = fecha.slice(0, 7);
        var desc = (ingresoPuntualDescInput.value || "").trim();
        var importe = parseFloat(ingresoPuntualImporteInput.value);
        if (!importe || isNaN(importe) || importe <= 0) {
          showToast("‚ö†Ô∏è Introduce un importe v√°lido");
          return;
        }
        ingresosPuntuales.push({
          id: Date.now().toString() + Math.random().toString(16).slice(2),
          fecha: fecha,
          mes: mes,
          desc: desc,
          importe: importe
        });
        saveJSON(LS_KEYS.INGRESOS_PUNTUALES, ingresosPuntuales);
        ingresoPuntualDescInput.value = "";
        ingresoPuntualImporteInput.value = "";
        showToast("‚úÖ Ingreso puntual a√±adido: " + formatCurrency(importe));
        renderAll();
      });
    }

    if (btnAddFijo) {
      btnAddFijo.addEventListener("click", function() {
        var nombre = (fijoNombreInput.value || "").trim();
        var importe = parseFloat(fijoImporteInput.value);
        if (!nombre) {
          showToast("‚ö†Ô∏è Introduce un nombre para el gasto fijo");
          return;
        }
        if (!importe || isNaN(importe) || importe <= 0) {
          showToast("‚ö†Ô∏è Introduce un importe v√°lido");
          return;
        }
        gastosFijos.push({
          id: Date.now().toString() + Math.random().toString(16).slice(2),
          nombre: nombre,
          importe: importe
        });
        saveJSON(LS_KEYS.FIJOS, gastosFijos);
        fijoNombreInput.value = "";
        fijoImporteInput.value = "";
        showToast("‚úÖ Gasto fijo a√±adido: " + nombre);
        renderAll();
      });
    }

    if (btnAddGasto) {
      btnAddGasto.addEventListener("click", function () {
        var fecha = gastoFechaInput.value || new Date().toISOString().slice(0, 10);
        var mes = fecha.slice(0, 7);
        var categoria = (gastoCategoriaInput.value || "").trim() || "Otros";
        var desc = (gastoDescInput.value || "").trim();
        var importe = parseFloat(gastoImporteInput.value);
        if (!importe || isNaN(importe) || importe <= 0) {
          showToast("‚ö†Ô∏è Introduce un importe v√°lido");
          return;
        }
        gastos.push({
          id: Date.now().toString() + Math.random().toString(16).slice(2),
          fecha: fecha,
          mes: mes,
          categoria: categoria,
          desc: desc,
          importe: importe
        });
        saveJSON(LS_KEYS.GASTOS, gastos);
        gastoDescInput.value = "";
        gastoImporteInput.value = "";
        gastoCategoriaInput.value = "";
        showToast("‚úÖ Gasto a√±adido: " + formatCurrency(importe));
        renderAll();
      });
    }

    if (btnAddSobre) {
      btnAddSobre.addEventListener("click", function () {
        var nombre = (sobreNombreInput.value || "").trim();
        var importe = parseFloat(sobreImporteInput.value) || 0;
        if (!nombre) {
          showToast("‚ö†Ô∏è Introduce un nombre para el presupuesto");
          return;
        }
        sobres[nombre] = importe;
        saveJSON(LS_KEYS.SOBRES, sobres);
        sobreNombreInput.value = "";
        sobreImporteInput.value = "";
        showToast("‚úÖ Presupuesto creado: " + nombre);
        renderAll();
      });
    }

    if (btnAddHucha) {
      btnAddHucha.addEventListener("click", function () {
        var nombre = (huchaNombreInput.value || "").trim();
        var objetivo = parseFloat(huchaObjetivoInput.value) || 0;
        var saldoInicial = parseFloat(huchaSaldoInicialInput.value) || 0;
        if (!nombre) {
          showToast("‚ö†Ô∏è Introduce un nombre para la hucha");
          return;
        }
        huchas.push({
          id: Date.now().toString() + Math.random().toString(16).slice(2),
          nombre: nombre,
          objetivo: objetivo,
          saldo: saldoInicial
        });
        saveJSON(LS_KEYS.HUCHAS, huchas);
        huchaNombreInput.value = "";
        huchaObjetivoInput.value = "";
        huchaSaldoInicialInput.value = "";
        showToast("‚úÖ Hucha creada: " + nombre);
        renderAll();
      });
    }

    if (btnHuchaMovimiento) {
      btnHuchaMovimiento.addEventListener("click", function () {
        var id = huchaSelect.value;
        var importe = parseFloat(huchaImporteInput.value);
        var accion = huchaAccionSelect.value || "aportar";
        if (!id) {
          showToast("‚ö†Ô∏è Selecciona una hucha");
          return;
        }
        if (!importe || isNaN(importe) || importe <= 0) {
          showToast("‚ö†Ô∏è Introduce un importe v√°lido");
          return;
        }
        var h = null;
        for (var i = 0; i < huchas.length; i++) {
          if (huchas[i].id === id) { h = huchas[i]; break; }
        }
        if (!h) return;
        var hoy = new Date().toISOString().slice(0, 10);
        var mes = hoy.slice(0, 7);
        if (accion === "aportar") {
          h.saldo = (h.saldo || 0) + importe;
          gastos.push({
            id: Date.now().toString() + Math.random().toString(16).slice(2),
            fecha: hoy,
            mes: mes,
            categoria: "Huchas",
            desc: "Aporte hucha " + h.nombre,
            importe: importe
          });
          showToast("‚úÖ Aportado " + formatCurrency(importe) + " a " + h.nombre);
        } else {
          if (h.saldo < importe) {
            showToast("‚ö†Ô∏è No hay suficiente saldo en la hucha");
            return;
          }
          h.saldo = (h.saldo || 0) - importe;
          showToast("‚úÖ Retirado " + formatCurrency(importe) + " de " + h.nombre);
        }
        saveJSON(LS_KEYS.HUCHAS, huchas);
        saveJSON(LS_KEYS.GASTOS, gastos);
        huchaImporteInput.value = "";
        renderAll();
      });
    }

    if (btnSaveNotas) {
      btnSaveNotas.addEventListener("click", function () {
        var mes = currentMonthKey();
        notasByMonth[mes] = notasMesTextarea.value || "";
        saveJSON(LS_KEYS.NOTAS, notasByMonth);
        showToast("‚úÖ Notas guardadas");
      });
    }

    document.addEventListener("click", function (e) {
      var btn = e.target.closest ? e.target.closest("button.btn-danger-chip") : null;
      if (!btn) return;
      var type = btn.getAttribute("data-type");
      var id = btn.getAttribute("data-id");
      if (!type || !id) return;
      var confirmMsg = "¬øSeguro que quieres eliminar este elemento?";
      if (!confirm(confirmMsg)) return;
      if (type === "gasto") {
        gastos = gastos.filter(function (g) { return g.id !== id; });
        saveJSON(LS_KEYS.GASTOS, gastos);
        showToast("‚úÖ Gasto eliminado");
      } else if (type === "ingresoPuntual") {
        ingresosPuntuales = ingresosPuntuales.filter(function (i) { return i.id !== id; });
        saveJSON(LS_KEYS.INGRESOS_PUNTUALES, ingresosPuntuales);
        showToast("‚úÖ Ingreso eliminado");
      } else if (type === "sobre") {
        delete sobres[id];
        saveJSON(LS_KEYS.SOBRES, sobres);
        showToast("‚úÖ Presupuesto eliminado");
      } else if (type === "hucha") {
        huchas = huchas.filter(function (h) { return h.id !== id; });
        saveJSON(LS_KEYS.HUCHAS, huchas);
        showToast("‚úÖ Hucha eliminada");
      } else if (type === "fijo") {
        gastosFijos = gastosFijos.filter(function (f) { return f.id !== id; });
        saveJSON(LS_KEYS.FIJOS, gastosFijos);
        showToast("‚úÖ Gasto fijo eliminado");
      }
      renderAll();
    });

    var tabButtons = document.querySelectorAll(".tab-btn");
    var tabSections = document.querySelectorAll(".tab-section");

    for (var iTab = 0; iTab < tabButtons.length; iTab++) {
      (function (btn) {
        btn.addEventListener("click", function () {
          var target = btn.getAttribute("data-tab-target");
          for (var j = 0; j < tabButtons.length; j++) {
            tabButtons[j].classList.remove("active");
          }
          btn.classList.add("active");
          for (var k = 0; k < tabSections.length; k++) {
            var sec = tabSections[k];
            if (sec.getAttribute("data-tab") === target) {
              sec.classList.add("active");
            } else {
              sec.classList.remove("active");
            }
          }
        });
      })(tabButtons[iTab]);
    }

    if (btnExportJson) {
      btnExportJson.addEventListener("click", function () {
        var payload = {
          meta: { app: "eco-familiar-v7", exportedAt: new Date().toISOString() },
          baseConfig: baseConfig,
          sobres: sobres,
          huchas: huchas,
          gastos: gastos,
          notasByMonth: notasByMonth,
          gastosFijos: gastosFijos,
          ingresosPuntuales: ingresosPuntuales
        };
        var blob = new Blob([JSON.stringify(payload, null, 2)], { type: "application/json" });
        var url = URL.createObjectURL(blob);
        var a = document.createElement("a");
        var today = new Date().toISOString().slice(0, 10);
        a.href = url;
        a.download = "eco_familiar_backup_" + today + ".json";
        document.body.appendChild(a);
        a.click();
        setTimeout(function () {
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
        }, 0);
        showToast("‚úÖ Copia de seguridad descargada");
      });
    }

    if (btnImportJsonFile && importFileInput) {
      btnImportJsonFile.addEventListener("click", function () {
        var file = importFileInput.files && importFileInput.files[0];
        if (!file) {
          showToast("‚ö†Ô∏è Selecciona un archivo JSON");
          return;
        }
        var reader = new FileReader();
        reader.onload = function (ev) {
          try {
            var data = JSON.parse(ev.target.result);
            applyBackupPayload(data);
            showToast("‚úÖ Datos importados correctamente");
          } catch (err) {
            console.error(err);
            showToast("‚ùå Error al importar el JSON");
          }
        };
        reader.readAsText(file, "utf-8");
      });
    }

    if (btnImportJsonText) {
      btnImportJsonText.addEventListener("click", function () {
        var txt = importJsonTextArea.value || "";
        if (!txt.trim()) {
          showToast("‚ö†Ô∏è Pega el contenido del JSON");
          return;
        }
        try {
          var data = JSON.parse(txt);
          applyBackupPayload(data);
          showToast("‚úÖ Datos importados correctamente");
          importJsonTextArea.value = "";
        } catch (err) {
          console.error(err);
          showToast("‚ùå El texto no es un JSON v√°lido");
        }
      });
    }

    function applyBackupPayload(data) {
      if (!data || typeof data !== "object") throw new Error("Formato inv√°lido");
      if (data.baseConfig) baseConfig = data.baseConfig;
      if (data.sobres) sobres = data.sobres;
      if (Array.isArray(data.huchas)) huchas = data.huchas;
      if (Array.isArray(data.gastos)) gastos = data.gastos;
      if (data.notasByMonth) notasByMonth = data.notasByMonth;
      if (Array.isArray(data.gastosFijos)) gastosFijos = data.gastosFijos;
      if (Array.isArray(data.ingresosPuntuales)) ingresosPuntuales = data.ingresosPuntuales;

      saveJSON(LS_KEYS.BASE, baseConfig);
      saveJSON(LS_KEYS.SOBRES, sobres);
      saveJSON(LS_KEYS.HUCHAS, huchas);
      saveJSON(LS_KEYS.GASTOS, gastos);
      saveJSON(LS_KEYS.NOTAS, notasByMonth);
      saveJSON(LS_KEYS.FIJOS, gastosFijos);
      saveJSON(LS_KEYS.INGRESOS_PUNTUALES, ingresosPuntuales);

      refreshCategorySuggestions();
      renderAll();
    }

    if (btnResetAll) {
      btnResetAll.addEventListener("click", function () {
        var ok = confirm("‚ö†Ô∏è ATENCI√ìN: Esto borrar√° TODOS los datos guardados (ingresos, gastos fijos, gastos, sobres, huchas y notas). Esta acci√≥n NO se puede deshacer. ¬øEst√°s completamente seguro?");
        if (!ok) return;
        baseConfig = { juan: 0, saray: 0, otros: 0 };
        sobres = {};
        huchas = [];
        gastos = [];
        notasByMonth = {};
        gastosFijos = [];
        ingresosPuntuales = [];
        saveJSON(LS_KEYS.BASE, baseConfig);
        saveJSON(LS_KEYS.SOBRES, sobres);
        saveJSON(LS_KEYS.HUCHAS, huchas);
        saveJSON(LS_KEYS.GASTOS, gastos);
        saveJSON(LS_KEYS.NOTAS, notasByMonth);
        saveJSON(LS_KEYS.FIJOS, gastosFijos);
        saveJSON(LS_KEYS.INGRESOS_PUNTUALES, ingresosPuntuales);
        refreshCategorySuggestions();
        renderAll();
        showToast("‚úÖ Todos los datos han sido eliminados");
      });
    }

    if (btnImportCsv && csvFileInput) {
      btnImportCsv.addEventListener("click", function () {
        var file = csvFileInput.files && csvFileInput.files[0];
        if (!file) {
          showToast("‚ö†Ô∏è Selecciona un archivo CSV");
          return;
        }
        var reader = new FileReader();
        reader.onload = function (ev) {
          try {
            var text = ev.target.result || "";
            var lines = text.split(/\r?\n/);
            if (!lines.length) return;
            var header = lines[0].split(";");
            var idxConcepto = header.indexOf("Concepto");
            var idxFecha = header.indexOf("Fecha");
            var idxImporte = header.indexOf("Importe");
            if (idxConcepto === -1 || idxFecha === -1 || idxImporte === -1) {
              showToast("‚ùå El CSV no tiene las columnas esperadas (Concepto;Fecha;Importe)");
              return;
            }
            var imported = 0;
            for (var i = 1; i < lines.length; i++) {
              var line = lines[i];
              if (!line || !line.trim()) continue;
              var cols = line.split(";");
              if (cols.length < header.length) continue;
              var concepto = (cols[idxConcepto] || "").trim();
              var fechaStr = (cols[idxFecha] || "").trim();
              var impStr = (cols[idxImporte] || "").trim();

              if (!fechaStr || !impStr) continue;

              var parts = fechaStr.split("/");
              var iso;
              if (parts.length === 3) {
                var d = parts[0]; if (d.length === 1) d = "0" + d;
                var m = parts[1]; if (m.length === 1) m = "0" + m;
                var y = parts[2];
                iso = y + "-" + m + "-" + d;
              } else {
                iso = new Date().toISOString().slice(0,10);
              }

              var valStr = impStr.replace("EUR", "").replace(/\./g, "").replace(",", ".").replace(/\s/g, "");
              var val = parseFloat(valStr);
              if (!val || isNaN(val)) continue;

              if (val < 0) {
                var importe = -val;
                gastos.push({
                  id: Date.now().toString() + Math.random().toString(16).slice(2),
                  fecha: iso,
                  mes: iso.slice(0,7),
                  categoria: "Banco",
                  desc: concepto,
                  importe: importe
                });
                imported++;
              }
            }
            saveJSON(LS_KEYS.GASTOS, gastos);
            renderAll();
            showToast("‚úÖ Importados " + imported + " movimientos desde CSV");
          } catch (e) {
            console.error(e);
            showToast("‚ùå Error al leer el CSV");
          }
        };
        reader.readAsText(file, "utf-8");
      });
    }

    // Inicializaci√≥n
    (function init() {
      var todayDate = new Date().toISOString().slice(0, 10);
      if (gastoFechaInput) gastoFechaInput.value = todayDate;
      if (ingresoPuntualFechaInput) ingresoPuntualFechaInput.value = todayDate;
      refreshCategorySuggestions();
      renderAll();
    })();
  </script>
</body>
</html>


